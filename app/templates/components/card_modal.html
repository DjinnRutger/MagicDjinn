{# ═══════════════════════════════════════════════════════════════════════════
   Card Detail / Edit Modal  (clean layout: image left, info + edit right)
   ═══════════════════════════════════════════════════════════════════════════
   Include once per page: {% include "components/card_modal.html" %}
   Open via JS by setting dlg.dataset.scryfallId then calling dlg.showModal()
#}
<dialog id="cardModal" aria-label="Card details" class="card-modal">
  <button type="button" class="btn-close card-modal-close-btn" id="cardModalClose" aria-label="Close"></button>

  <div class="card-modal-body">

    {# ── Left: image · edition/variant picker · prices · rarity ── #}
    <div class="card-modal-img-col">

      <div class="card-modal-img-wrap" id="modal-img-wrap">
        <img id="modal-card-image" src="" alt="" class="card-modal-img">
        <div class="mtg-foil-shimmer" id="modal-foil-shimmer" style="display:none"></div>
      </div>

      {# Edition + variant selects — hidden until printings load #}
      <div id="modal-edition-row" style="display:none" class="mt-2">
        <label class="form-label form-label-sm mb-1" style="font-size:.7rem;text-transform:uppercase;letter-spacing:.05em;color:var(--bs-secondary-color)">Edition</label>
        <select id="modal-edition-select" class="form-select form-select-sm mb-1"
                title="Set / Edition"></select>
        <select id="modal-variant-select" class="form-select form-select-sm"
                title="Variant / collector number"></select>
      </div>

      <div class="card-modal-price-rows mt-2">
        <div class="card-modal-price-row">
          <span class="card-modal-price-lbl">Market</span>
          <strong id="modal-price-usd" class="card-modal-price-val">—</strong>
        </div>
        <div class="card-modal-price-row">
          <span class="card-modal-price-lbl">Foil</span>
          <strong id="modal-price-foil" class="card-modal-price-val">—</strong>
        </div>
      </div>

      <div class="text-center mt-2">
        <span id="modal-rarity-badge" class="badge rounded-pill"></span>
      </div>
    </div>

    {# ── Right: card info + edit controls ── #}
    <div class="card-modal-details-col">

      <h5 id="modal-card-name" class="mb-1 fw-bold lh-sm">—</h5>
      <small id="modal-card-set" class="text-muted d-block mb-1"></small>
      <div id="modal-mana-cost" class="mb-1"
           style="font-size:.9rem;letter-spacing:.04em;font-weight:600"></div>
      <div id="modal-type-line" class="text-muted mb-2" style="font-size:.82rem"></div>
      <div id="modal-oracle-text" class="card-modal-oracle mb-3"></div>

      <hr class="my-2">

      {# ── Edit section ── #}
      <div id="modal-edit-section">
        <p class="modal-section-label mb-2">Your Copy</p>

        <div class="row g-2 mb-2">
          <div class="col-4">
            <label class="form-label form-label-sm">Quantity</label>
            <input type="number" id="modal-qty" class="form-control form-control-sm"
                   min="1" max="99" value="1">
          </div>
          <div class="col-4">
            <label class="form-label form-label-sm">Condition</label>
            <select id="modal-condition" class="form-select form-select-sm">
              <option value="NM">NM — Near Mint</option>
              <option value="EX">EX — Excellent</option>
              <option value="GD">GD — Good</option>
              <option value="LP">LP — Lightly Played</option>
              <option value="PL">PL — Played</option>
              <option value="PO">PO — Poor</option>
            </select>
          </div>
          <div class="col-4">
            <label class="form-label form-label-sm">Paid (USD)</label>
            <input type="number" id="modal-purchase-price" class="form-control form-control-sm"
                   placeholder="0.00" step="0.01" min="0">
          </div>
        </div>

        <div class="mb-2">
          <div class="form-check">
            <input type="checkbox" id="modal-is-foil" class="form-check-input">
            <label for="modal-is-foil" class="form-check-label">Foil</label>
          </div>
        </div>

        <div class="mb-2">
          <label class="form-label form-label-sm">Physical Location</label>
          <input type="text" id="modal-physical-location" class="form-control form-control-sm"
                 placeholder="e.g. Binder 3, Shelf Box A…" maxlength="200">
        </div>

        <div class="mb-3">
          <label class="form-label form-label-sm">Notes</label>
          <textarea id="modal-notes" class="form-control form-control-sm"
                    rows="2" placeholder="Optional notes about this copy…" maxlength="500"></textarea>
        </div>

        <div id="modal-alert" style="display:none" class="mb-2"></div>

        <div class="d-flex gap-2 mb-2">
          <button id="modal-save-btn" type="button" class="btn btn-primary btn-sm flex-grow-1">
            <i class="bi bi-check-lg me-1"></i>Save Changes
          </button>
          <button id="modal-delete-btn" type="button" class="btn btn-outline-danger btn-sm">
            <i class="bi bi-trash"></i>
          </button>
        </div>

        {# ── Deck-only actions ── #}
        <div id="modal-deck-section" style="display:none">
          <hr class="my-2">
          <div class="d-flex gap-3 mb-2 flex-wrap">
            <div class="form-check">
              <input type="checkbox" id="modal-cover-card" class="form-check-input">
              <label for="modal-cover-card" class="form-check-label fw-semibold" style="font-size:.85rem">
                <i class="bi bi-image me-1 text-primary"></i>Cover Card
              </label>
            </div>
            <div class="form-check" id="modal-commander-row" style="display:none">
              <input type="checkbox" id="modal-is-commander" class="form-check-input">
              <label for="modal-is-commander" class="form-check-label fw-semibold" style="font-size:.85rem">
                <i class="bi bi-crown me-1 text-warning"></i>Commander
              </label>
            </div>
          </div>
          <div class="form-check mb-2">
            <input type="checkbox" id="modal-is-sideboard" class="form-check-input">
            <label for="modal-is-sideboard" class="form-check-label" style="font-size:.85rem">
              <i class="bi bi-collection me-1 text-secondary"></i>Sideboard
            </label>
          </div>
          <button id="modal-return-box-btn" type="button" class="btn btn-outline-secondary btn-sm w-100">
            <i class="bi bi-box-arrow-left me-1"></i>Return to Box
          </button>
        </div>
      </div>

    </div>{# /details col #}
  </div>{# /body #}
</dialog>

<style>
/* ── Modal container ──────────────────────────────────────────────────────── */
dialog.card-modal {
  border: none; border-radius: 14px; padding: 0;
  width: min(95vw, 780px); max-height: 92vh; overflow: hidden;
  box-shadow: 0 25px 60px rgba(0,0,0,.5);
  background: var(--bs-body-bg); color: var(--bs-body-color);
}
dialog.card-modal::backdrop { background: rgba(0,0,0,.7); backdrop-filter: blur(3px); }

/* Floating close button */
.card-modal-close-btn { position: absolute; top: .9rem; right: .9rem; z-index: 10; }

/* Body layout */
.card-modal-body {
  display: flex; gap: 1.5rem;
  padding: 1.4rem 1.25rem 1.25rem;
  overflow-y: auto; max-height: 92vh;
}

/* Image column */
.card-modal-img-col  { flex-shrink: 0; width: 210px; }
.card-modal-img-wrap {
  border-radius: 10px; overflow: hidden; position: relative;
  aspect-ratio: 63/88; background: var(--bs-tertiary-bg);
  box-shadow: 0 8px 24px rgba(0,0,0,.35);
}
.card-modal-img { width: 100%; height: 100%; object-fit: cover; display: block; }

/* Price rows */
.card-modal-price-rows {
  background: var(--bs-tertiary-bg); border-radius: 8px;
  padding: .45rem .65rem; font-size: .82rem;
}
.card-modal-price-row {
  display: flex; justify-content: space-between; align-items: baseline;
  padding: .1rem 0;
}
.card-modal-price-lbl {
  color: var(--bs-secondary-color); font-size: .72rem;
  text-transform: uppercase; letter-spacing: .04em;
}
.card-modal-price-val { font-weight: 600; }

/* Info column */
.card-modal-details-col {
  flex: 1; min-width: 0;
  display: flex; flex-direction: column;
  padding-top: .15rem;
}

/* Oracle text */
.card-modal-oracle {
  font-size: .85rem; line-height: 1.7; white-space: pre-wrap;
  max-height: 160px; overflow-y: auto;
  padding: .5rem .75rem;
  background: var(--bs-tertiary-bg); border-radius: 6px;
}

/* Foil shimmer */
.mtg-foil-shimmer {
  position: absolute; inset: 0; border-radius: 9px;
  background: linear-gradient(135deg,rgba(255,215,0,.0) 0%,rgba(255,215,0,.18) 30%,rgba(255,255,255,.12) 50%,rgba(180,0,255,.12) 70%,rgba(0,180,255,.0) 100%);
  pointer-events: none;
}

/* Mobile */
@media (max-width: 580px) {
  .card-modal-body    { flex-direction: column; padding: 2.5rem 1rem 1rem; }
  .card-modal-img-col { width: 100%; max-width: 210px; margin: 0 auto; }
}
</style>

<script>
(function () {
  'use strict';

  var dlg = document.getElementById('cardModal');

  /* ── Edition / variant state ─────────────────────────────────────────────── */
  var _allPrintings      = null;   // full /all-printings response
  var _selectedPrintingId = null;  // currently previewed scryfall_id
  var _originalPrintingId = null;  // id when modal was opened

  /* Expose to page save-handlers */
  Object.defineProperty(window, '_modalSelectedPrintingId', {
    get: function () { return _selectedPrintingId; }, configurable: true,
  });
  Object.defineProperty(window, '_modalOriginalPrintingId', {
    get: function () { return _originalPrintingId; }, configurable: true,
  });

  /* ── Load all-printings on modal open (MutationObserver) ─────────────────── */
  new MutationObserver(function (mutations) {
    for (var i = 0; i < mutations.length; i++) {
      if (mutations[i].attributeName === 'open' && dlg.hasAttribute('open')) {
        var sid = dlg.dataset.scryfallId || '';
        _allPrintings       = null;
        _selectedPrintingId = sid || null;
        _originalPrintingId = sid || null;
        document.getElementById('modal-edition-row').style.display = 'none';
        if (sid) _loadAllPrintings(sid);
        break;
      }
    }
  }).observe(dlg, { attributes: true, attributeFilter: ['open'] });

  /* ── Fetch + populate dropdowns ──────────────────────────────────────────── */
  function _loadAllPrintings(sid) {
    fetch('/api/cards/' + encodeURIComponent(sid) + '/all-printings')
      .then(function (r) { return r.ok ? r.json() : null; })
      .then(function (data) {
        if (!data || !data.sets || !data.sets.length) return;
        _allPrintings = data;
        _populateEditionSelect(data.sets, data.current_scryfall_id);
        document.getElementById('modal-edition-row').style.display = '';
      })
      .catch(function () { /* silently skip — edition picker is a bonus */ });
  }

  function _populateEditionSelect(sets, currentSid) {
    var edSel = document.getElementById('modal-edition-select');
    edSel.innerHTML = '';
    var currentSetCode = null;
    sets.forEach(function (s) {
      s.printings.forEach(function (p) {
        if (p.scryfall_id === currentSid) currentSetCode = s.set_code;
      });
    });
    sets.forEach(function (s) {
      var opt = document.createElement('option');
      opt.value = s.set_code;
      opt.textContent = s.set_name + ' (' + s.set_code + ')';
      if (s.set_code === currentSetCode) opt.selected = true;
      edSel.appendChild(opt);
    });
    _populateVariantSelect(currentSetCode, currentSid);
  }

  function _populateVariantSelect(setCode, activeSid) {
    var varSel = document.getElementById('modal-variant-select');
    varSel.innerHTML = '';
    if (!_allPrintings) return;
    var set = _allPrintings.sets.find(function (s) { return s.set_code === setCode; });
    if (!set) return;
    set.printings.forEach(function (p) {
      var opt = document.createElement('option');
      opt.value = p.scryfall_id;
      var label = '#' + p.collector_number;
      if (p.frame_effects && p.frame_effects.length) label += ' [' + p.frame_effects.join(', ') + ']';
      if (p.usd != null) label += ' — $' + parseFloat(p.usd).toFixed(2);
      opt.textContent = label;
      if (p.scryfall_id === activeSid) opt.selected = true;
      varSel.appendChild(opt);
    });
    /* Sync preview to the active selection */
    var active = set.printings.find(function (p) { return p.scryfall_id === activeSid; })
               || set.printings[0];
    if (active) _applyPrintingPreview(active);
  }

  function _applyPrintingPreview(printing) {
    _selectedPrintingId = printing.scryfall_id;
    if (printing.image_small) {
      document.getElementById('modal-card-image').src = printing.image_small;
    }
    var usd  = printing.usd      != null ? '$' + parseFloat(printing.usd).toFixed(2)      : '—';
    var foil = printing.usd_foil != null ? '$' + parseFloat(printing.usd_foil).toFixed(2) : '—';
    document.getElementById('modal-price-usd').textContent  = usd;
    document.getElementById('modal-price-foil').textContent = foil;
    /* Update set label to match selected printing */
    var setLabel = document.getElementById('modal-card-set');
    if (setLabel && _allPrintings) {
      var set = _allPrintings.sets.find(function (s) {
        return s.printings.some(function (p) { return p.scryfall_id === printing.scryfall_id; });
      });
      if (set) setLabel.textContent = set.set_code + ' — ' + set.set_name;
    }
  }

  /* Edition change → repopulate variants → preview first */
  document.getElementById('modal-edition-select').addEventListener('change', function () {
    if (!_allPrintings) return;
    var set = _allPrintings.sets.find(function (s) { return s.set_code === this.value; }, this);
    if (set && set.printings.length) _populateVariantSelect(this.value, set.printings[0].scryfall_id);
  });

  /* Variant change → update preview */
  document.getElementById('modal-variant-select').addEventListener('change', function () {
    if (!_allPrintings) return;
    var setCode = document.getElementById('modal-edition-select').value;
    var set = _allPrintings.sets.find(function (s) { return s.set_code === setCode; });
    if (!set) return;
    var printing = set.printings.find(function (p) { return p.scryfall_id === this.value; }, this);
    if (printing) _applyPrintingPreview(printing);
  });

  /* ── Deck section ────────────────────────────────────────────────────────── */
  var _deckCtx = null;

  window._showDeckModalSection = function (deckId, coverScryfallId, invId, csrfToken, opts) {
    opts = opts || {};
    _deckCtx = { deck_id: deckId, cover_scryfall_id: coverScryfallId, inv_id: invId, csrf: csrfToken };
    var sec = document.getElementById('modal-deck-section');
    if (sec) sec.style.display = '';
    var cb = document.getElementById('modal-cover-card');
    if (cb) cb.checked = !!(coverScryfallId && dlg.dataset.scryfallId === coverScryfallId);
    // Sideboard checkbox
    var sbCb = document.getElementById('modal-is-sideboard');
    if (sbCb) sbCb.checked = !!opts.is_sideboard;
    // Commander checkbox — only show for Commander format decks
    var cmdRow = document.getElementById('modal-commander-row');
    var cmdCb  = document.getElementById('modal-is-commander');
    if (cmdRow && cmdCb) {
      cmdRow.style.display = opts.is_commander_format ? '' : 'none';
      cmdCb.checked = !!opts.is_commander;
    }
  };

  window._hideDeckModalSection = function () {
    _deckCtx = null;
    var sec = document.getElementById('modal-deck-section');
    if (sec) sec.style.display = 'none';
  };

  /* Cover card */
  document.getElementById('modal-cover-card').addEventListener('change', function () {
    if (!_deckCtx) return;
    var newSid = this.checked ? (dlg.dataset.scryfallId || null) : null;
    fetch('/decks/' + _deckCtx.deck_id + '/set-cover', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': _deckCtx.csrf },
      body: JSON.stringify({ scryfall_id: newSid }),
    })
    .then(function (r) { return r.json(); })
    .then(function (d) {
      if (d.success) {
        _deckCtx.cover_scryfall_id = newSid;
        if (window._onCoverSidChange) window._onCoverSidChange(newSid);
        _cmToast(newSid ? 'Cover card set!' : 'Cover card cleared.', 'success');
      }
    })
    .catch(function () { _cmToast('Could not update cover card.', 'danger'); });
  });

  /* Return to Box */
  document.getElementById('modal-return-box-btn').addEventListener('click', function () {
    if (!_deckCtx) return;
    if (!confirm('Return this card to your Box?')) return;
    var btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Returning…';
    fetch('/decks/' + _deckCtx.deck_id + '/remove-card/' + _deckCtx.inv_id, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': _deckCtx.csrf },
      body: JSON.stringify({}),
    })
    .then(function (r) { return r.json(); })
    .then(function (d) {
      if (d.success) { dlg.close(); window.location.reload(); }
      else {
        _cmToast(d.error || 'Could not return card.', 'danger');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-box-arrow-left me-1"></i>Return to Box';
      }
    })
    .catch(function () {
      _cmToast('Network error.', 'danger');
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-box-arrow-left me-1"></i>Return to Box';
    });
  });

  /* Minimal toast */
  function _cmToast(msg, type) {
    if (window._pageToast) { window._pageToast(msg, type); return; }
    var el = document.createElement('div');
    el.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed';
    el.style.cssText = 'bottom:1.5rem;right:1.5rem;z-index:9999;min-width:240px;max-width:380px';
    el.innerHTML = msg + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    document.body.appendChild(el);
    setTimeout(function () { el.remove(); }, 3000);
  }
})();
</script>
