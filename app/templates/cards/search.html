{% extends "base.html" %}
{% block title %}Card Search — {{ get_setting('app_name', 'MagicDjinn') }}{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb mb-0">
  <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Home</a></li>
  <li class="breadcrumb-item active">Card Search</li>
</ol>
{% endblock %}

{% block page_header %}
<div class="page-header">
  <div>
    <h1>Card Search</h1>
    <p class="lead mb-0">Search your collection or explore Scryfall</p>
  </div>
</div>
{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<style>
/* ── Tabs ──────────────────────────────────────────────────────────────────── */
.search-tabs {
  display: flex; gap: 0; border-bottom: 2px solid var(--bs-border-color);
  margin-bottom: 1.25rem;
}
.search-tab {
  padding: .5rem 1.25rem; font-size: .88rem; font-weight: 600;
  border: none; background: none; color: var(--bs-secondary-color);
  border-bottom: 2px solid transparent; margin-bottom: -2px;
  cursor: pointer; transition: color .15s, border-color .15s;
}
.search-tab.active  { color: var(--primary); border-bottom-color: var(--primary); }
.search-tab:hover:not(.active) { color: var(--bs-body-color); }

/* ── Card grid ─────────────────────────────────────────────────────────────── */
/* rem units inherit the root font-size, so tiles grow with the ui_scale setting */
.cs-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(7.2rem, 1fr));
  gap: .75rem;
}
@media (max-width: 576px) {
  .cs-grid { grid-template-columns: repeat(auto-fill, minmax(5.6rem, 1fr)); gap: .5rem; }
}
.cs-tile {
  border-radius: 9px; overflow: hidden; position: relative;
  background: var(--bs-tertiary-bg);
  transition: transform .2s, box-shadow .2s;
}
.cs-tile:hover { transform: translateY(-4px) scale(1.03); box-shadow: 0 10px 24px rgba(0,0,0,.35); z-index:5; position:relative; }
.cs-img-wrap { aspect-ratio: 63/88; position: relative; }
.cs-img-wrap img { width:100%; height:100%; object-fit:cover; display:block; border-radius:9px 9px 0 0; }
.cs-img-placeholder { width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:1.8rem; color:var(--bs-secondary-color); }
.cs-badges { position:absolute; top:4px; right:4px; display:flex; flex-direction:column; gap:2px; align-items:flex-end; }
.cs-info { padding:4px 6px 6px; }
.cs-name { font-size:.68rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.cs-meta { font-size:.6rem; color:var(--bs-secondary-color); margin-top:1px; }

/* Hover overlay */
.cs-overlay {
  position:absolute; inset:0; border-radius:9px 9px 0 0;
  background:rgba(0,0,0,.68);
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:.35rem;
  opacity:0; transition:opacity .18s; padding:.4rem;
}
.cs-tile:hover .cs-overlay { opacity:1; }
.cs-overlay .cs-ov-name { color:#fff; font-size:.65rem; font-weight:700; text-align:center; line-height:1.2; }
.cs-overlay .cs-ov-owner { color:rgba(255,255,255,.65); font-size:.58rem; }
.cs-overlay .btn-add-box {
  font-size:.62rem; padding:.22rem .55rem;
  background:#fff; color:#1e293b; border:none; border-radius:5px; cursor:pointer; font-weight:600;
  margin-top:.15rem;
}
.cs-overlay .btn-add-box:hover { background:#e2e8f0; }

/* Skeleton */
.cs-skel { border-radius:9px; background:linear-gradient(90deg,var(--bs-tertiary-bg) 25%,var(--bs-border-color) 50%,var(--bs-tertiary-bg) 75%); background-size:200% 100%; animation:skelPulse 1.4s ease infinite; }
@keyframes skelPulse { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

/* Legality pills */
.leg-pill { font-size:.52rem; padding:.1rem .4rem; border-radius:99px; font-weight:600; }
.leg-legal   { background:#16a34a22; color:#16a34a; }
.leg-not_legal { background:#dc262622; color:#dc2626; }
.leg-banned  { background:#7c3aed22; color:#7c3aed; }
.leg-restricted { background:#d9770622; color:#d97706; }

/* ── Collection Value card grid ──────────────────────────────────────────── */
.val-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: .9rem;
}
@media (min-width: 640px)  { .val-grid { grid-template-columns: repeat(3, 1fr); } }
@media (min-width: 1100px) { .val-grid { grid-template-columns: repeat(4, 1fr); } }

.val-card {
  border-radius: 10px; overflow: hidden;
  background: var(--bs-tertiary-bg);
  border: 1px solid var(--bs-border-color);
  cursor: pointer;
  transition: transform .2s, box-shadow .2s;
}
.val-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 12px 28px rgba(0,0,0,.38); z-index: 5; position: relative; }
.val-card-img-wrap { position: relative; aspect-ratio: 63/88; }
.val-card-img-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; border-radius: 10px 10px 0 0; }
.val-card-img-ph {
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
  font-size: 3rem; color: var(--bs-secondary-color);
  background: var(--bs-tertiary-bg); border-radius: 10px 10px 0 0;
}
.val-card-rank {
  position: absolute; top: 6px; left: 6px;
  font-size: .6rem; font-weight: 700;
  background: rgba(0,0,0,.65); color: #fff;
  padding: .1rem .38rem; border-radius: 99px; line-height: 1.6;
}
.val-card-qty {
  position: absolute; top: 6px; right: 6px;
  font-size: .6rem; font-weight: 600;
  background: rgba(0,0,0,.65); color: #fff;
  padding: .1rem .38rem; border-radius: 99px; line-height: 1.6;
}
.val-card-info  { padding: .5rem .6rem .6rem; }
.val-card-price { font-size: 1.05rem; font-weight: 800; color: #16a34a; line-height: 1; }
.val-card-total { font-size: .65rem; color: var(--bs-secondary-color); margin-top: 2px; }
.val-card-name  { font-size: .72rem; font-weight: 600; margin-top: .38rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.val-card-sub   { font-size: .62rem; color: var(--bs-secondary-color); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

</style>
{% endblock %}

{% block content %}

{# ── Tab nav ──────────────────────────────────────────────────────────────── #}
<div class="search-tabs" role="tablist">
  <button class="search-tab {% if source == 'all' %}active{% endif %}"
          data-tab="all" onclick="switchTab('all')">
    <i class="bi bi-grid3x2-gap me-1"></i>All Cards
  </button>
  <button class="search-tab {% if source == 'collection' %}active{% endif %}"
          data-tab="collection" onclick="switchTab('collection')">
    <i class="bi bi-collection me-1"></i>My Collection
  </button>
  <button class="search-tab {% if source == 'scryfall' %}active{% endif %}"
          data-tab="scryfall" onclick="switchTab('scryfall')">
    <i class="bi bi-globe2 me-1"></i>Scryfall Search
  </button>
  <button class="search-tab {% if source == 'value' %}active{% endif %}"
          data-tab="value" onclick="switchTab('value')">
    <i class="bi bi-currency-dollar me-1"></i>Collection Value
  </button>
</div>

{# ── My Collection tab ────────────────────────────────────────────────────── #}
<div id="tab-collection" {% if source != 'collection' %}style="display:none"{% endif %}>

  <div class="d-flex gap-2 mb-3 flex-wrap align-items-center">
    <div style="flex:1;min-width:200px;max-width:400px">
      <input type="search" id="mcSearch"
             placeholder="Filter by card name…"
             class="form-control" autocomplete="off">
    </div>
    <select id="mcLocationFilter" class="form-select form-select-sm"
            style="width:auto;min-width:160px;max-width:220px"
            title="Filter by physical location">
      <option value="">All Locations</option>
    </select>
    <div class="form-check mb-0">
      <input type="checkbox" id="mcAvailable" class="form-check-input">
      <label for="mcAvailable" class="form-check-label" style="font-size:.82rem;white-space:nowrap">Available only</label>
    </div>
    <span id="mcMeta" class="text-muted" style="font-size:.82rem;white-space:nowrap"></span>
  </div>

  <div id="mcLoading" class="text-center py-4 text-muted" style="display:none">
    <span class="spinner-border spinner-border-sm me-1"></span> Loading your collection…
  </div>

  <div id="mcGrid" class="cs-grid"></div>

  <div id="mcEmpty" class="text-center py-5 text-muted" style="display:none">
    <i class="bi bi-collection" style="font-size:2.5rem;opacity:.2"></i>
    <p class="mt-2" style="font-size:.88rem">No cards match your filter.</p>
  </div>

  <div id="mcPlaceholder" class="text-center py-5 text-muted">
    <i class="bi bi-collection" style="font-size:2.5rem;opacity:.2"></i>
    <p class="mt-2" style="font-size:.88rem">Your Box and all Decks in one place.</p>
  </div>

</div>{# /tab-collection #}

{# ── Scryfall search tab ───────────────────────────────────────────────────── #}
<div id="tab-scryfall" {% if source != 'scryfall' %}style="display:none"{% endif %}>

  <div class="d-flex gap-2 mb-2 flex-wrap align-items-start">
    <div style="flex:1;min-width:200px;max-width:500px">
      <input type="search" id="scryfallQuery"
             placeholder="e.g. t:creature c:red cmc<=2 or just Lightning Bolt"
             class="form-control"
             value="{{ q if source == 'scryfall' else '' }}">
      <div class="form-text">
        Supports full <a href="https://scryfall.com/docs/syntax" target="_blank" rel="noopener">Scryfall syntax</a>
        — t:creature, c:w, cmc&lt;=3, o:flying, is:foil, etc.
      </div>
    </div>
    <button class="btn btn-primary" id="scryfallSearchBtn" onclick="runScryfallSearch()">
      <i class="bi bi-globe2 me-1"></i>Search Scryfall
    </button>
  </div>

  {# Results area #}
  <div id="sfSkelGrid" class="cs-grid" style="display:none">
    {% for _ in range(12) %}
    <div class="cs-skel" style="aspect-ratio:63/88;border-radius:9px"></div>
    {% endfor %}
  </div>

  <div id="sfMeta" class="text-muted mb-2" style="font-size:.82rem;display:none"></div>

  <div id="sfResultsGrid" class="cs-grid"></div>

  <div id="sfError" class="alert alert-warning" style="display:none"></div>

  <div id="sfEmpty" class="text-center py-5 text-muted" style="display:none">
    <i class="bi bi-globe2" style="font-size:2.5rem;opacity:.2"></i>
    <p class="mt-2" style="font-size:.88rem">Search Scryfall to explore all Magic cards.</p>
  </div>

</div>{# /tab-scryfall #}

{# ── All Cards tab ─────────────────────────────────────────────────────────── #}
<div id="tab-all" {% if source != 'all' %}style="display:none"{% endif %}>

  <div class="d-flex gap-2 mb-3 flex-wrap align-items-center">
    <div style="flex:1;min-width:200px;max-width:400px">
      <input type="search" id="allCardsSearch"
             placeholder="Filter by card name…"
             class="form-control" autocomplete="off">
    </div>
    <div class="form-check mb-0">
      <input type="checkbox" id="allAvailable" class="form-check-input">
      <label for="allAvailable" class="form-check-label" style="font-size:.82rem;white-space:nowrap">Available only</label>
    </div>
    <span id="allCardsMeta" class="text-muted" style="font-size:.82rem;white-space:nowrap"></span>
  </div>

  <div id="allCardsLoading" class="text-center py-4 text-muted" style="display:none">
    <span class="spinner-border spinner-border-sm me-1"></span> Loading all cards…
  </div>

  <div id="allCardsGrid" class="cs-grid"></div>

  <div id="allCardsEmpty" class="text-center py-5 text-muted" style="display:none">
    <i class="bi bi-grid3x2-gap" style="font-size:2.5rem;opacity:.2"></i>
    <p class="mt-2" style="font-size:.88rem">No cards match your filter.</p>
  </div>

  <div id="allCardsPlaceholder" class="text-center py-5 text-muted">
    <i class="bi bi-grid3x2-gap" style="font-size:2.5rem;opacity:.2"></i>
    <p class="mt-2" style="font-size:.88rem">
      All cards from your Box, decks, and friends' shared collections.
    </p>
  </div>

</div>{# /tab-all #}

{# ── Collection Value tab ──────────────────────────────────────────────────── #}
<div id="tab-value" {% if source != 'value' %}style="display:none"{% endif %}>

  <div class="d-flex gap-2 mb-3 flex-wrap align-items-center">
    <div style="flex:1;min-width:200px;max-width:400px">
      <input type="search" id="valueSearch"
             placeholder="Filter by card name…"
             class="form-control" autocomplete="off">
    </div>
    <span id="valueMeta" class="text-muted" style="font-size:.82rem;white-space:nowrap"></span>
  </div>

  <div id="valueLoading" class="text-center py-4 text-muted" style="display:none">
    <span class="spinner-border spinner-border-sm me-1"></span> Loading collection…
  </div>

  <div id="valueList" class="val-grid"></div>

  <div id="valueEmpty" class="text-center py-5 text-muted" style="display:none">
    <i class="bi bi-currency-dollar" style="font-size:2.5rem;opacity:.2"></i>
    <p class="mt-2" style="font-size:.88rem">No cards with known prices in your collection.</p>
  </div>

  <div id="valuePlaceholder" class="text-center py-5 text-muted">
    <i class="bi bi-currency-dollar" style="font-size:2.5rem;opacity:.2"></i>
    <p class="mt-2" style="font-size:.88rem">Your entire collection ranked by card value.</p>
  </div>

</div>{# /tab-value #}

{# ── All-Cards read-only detail dialog ───────────────────────────────────────── #}
<dialog id="allCardsDlg" style="max-width:min(720px,95vw);width:100%;border:none;border-radius:14px;padding:0;background:var(--bs-body-bg);color:var(--bs-body-color);box-shadow:0 24px 80px rgba(0,0,0,.55)">
  <div style="display:flex;gap:1.5rem;padding:1.75rem;align-items:flex-start">

    {# ── Card image column ── #}
    <div style="flex-shrink:0;width:200px">
      <div style="position:relative">
        <img id="acd-image" src="" alt="" style="width:100%;border-radius:10px;display:block;box-shadow:0 4px 16px rgba(0,0,0,.4)">
        <div id="acd-no-image" style="display:none;width:200px;aspect-ratio:63/88;background:var(--bs-tertiary-bg);border-radius:10px;align-items:center;justify-content:center;font-size:3rem;color:var(--bs-secondary-color)">
          <i class="bi bi-card-image"></i>
        </div>
        <div id="acd-foil-shimmer" style="display:none;position:absolute;inset:0;border-radius:10px;background:linear-gradient(135deg,rgba(255,215,0,.0) 0%,rgba(255,215,0,.22) 30%,rgba(255,255,255,.14) 50%,rgba(180,0,255,.14) 70%,rgba(0,180,255,.0) 100%);pointer-events:none"></div>
      </div>
      {# Prices below image #}
      <div style="margin-top:.85rem;display:flex;flex-direction:column;gap:.35rem">
        <div style="font-size:.8rem;display:flex;justify-content:space-between;padding:.3rem .5rem;background:var(--bs-tertiary-bg);border-radius:6px">
          <span class="text-muted">Market</span><strong id="acd-usd">—</strong>
        </div>
        <div style="font-size:.8rem;display:flex;justify-content:space-between;padding:.3rem .5rem;background:var(--bs-tertiary-bg);border-radius:6px">
          <span class="text-muted">Foil</span><strong id="acd-usd-foil">—</strong>
        </div>
        <div style="font-size:.8rem;display:flex;justify-content:space-between;padding:.3rem .5rem;background:var(--bs-tertiary-bg);border-radius:6px">
          <span class="text-muted">Qty</span><strong id="acd-qty">—</strong>
        </div>
      </div>
    </div>

    {# ── Info column ── #}
    <div style="flex:1;min-width:0">
      <div class="d-flex align-items-start justify-content-between gap-2 mb-3">
        <h4 id="acd-name" class="mb-0 fw-bold" style="font-size:1.15rem;line-height:1.3"></h4>
        <button id="acd-close" style="border:none;background:none;font-size:1.5rem;line-height:1;padding:.15rem .4rem;cursor:pointer;color:var(--bs-secondary-color);flex-shrink:0;border-radius:6px" title="Close">×</button>
      </div>

      <div class="d-flex gap-1 flex-wrap mb-3">
        <span id="acd-location-badge" class="badge" style="font-size:.72rem;padding:.3rem .6rem"></span>
        <span id="acd-rarity-badge"   class="badge" style="font-size:.72rem;padding:.3rem .6rem"></span>
      </div>

      <dl style="display:grid;grid-template-columns:auto 1fr;gap:.25rem .75rem;font-size:.85rem;margin-bottom:.75rem">
        <dt class="text-muted fw-normal" style="white-space:nowrap">Set</dt>
        <dd id="acd-set" class="mb-0" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></dd>
        <dt class="text-muted fw-normal" style="white-space:nowrap">Type</dt>
        <dd id="acd-type" class="mb-0"></dd>
        <dt id="acd-mana-label" class="text-muted fw-normal" style="white-space:nowrap">Mana</dt>
        <dd id="acd-mana" class="mb-0"></dd>
      </dl>

      <div style="border-top:1px solid var(--bs-border-color);padding-top:.75rem">
        <div class="text-muted" style="font-size:.72rem;font-weight:600;letter-spacing:.04em;margin-bottom:.4rem">ORACLE TEXT</div>
        <div id="acd-oracle" style="font-size:.85rem;max-height:150px;overflow-y:auto;white-space:pre-wrap;line-height:1.55"></div>
      </div>

      {# ── Add to Deck (shown only when card is in Your Box) ── #}
      <div id="acd-add-section" style="display:none;margin-top:.85rem;border-top:1px solid var(--bs-border-color);padding-top:.85rem">
        <div class="text-muted mb-2" style="font-size:.72rem;font-weight:600;letter-spacing:.04em;text-transform:uppercase">Add to Deck</div>
        <div class="d-flex gap-2 align-items-center flex-wrap">
          <select id="acd-deck-select" class="form-select form-select-sm" style="flex:1;min-width:140px"></select>
          <input type="number" id="acd-add-qty" class="form-control form-control-sm" style="width:68px" value="1" min="1" max="99">
          <button id="acd-add-btn" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-lg me-1"></i>Add
          </button>
        </div>
        <div id="acd-add-msg" style="font-size:.78rem;margin-top:.35rem;min-height:1.1em"></div>
      </div>
    </div>

  </div>
</dialog>

{# ── Price History Modal (Chart.js) ──────────────────────────────────────── #}
{% include "components/price_history_modal.html" %}

{# ── Scryfall card detail dialog ──────────────────────────────────────────── #}
<dialog id="sfDetailDlg" style="max-width:min(720px,95vw);width:100%;border:none;border-radius:14px;padding:0;background:var(--bs-body-bg);color:var(--bs-body-color);box-shadow:0 24px 80px rgba(0,0,0,.55)">
  <div style="display:flex;gap:1.5rem;padding:1.75rem;align-items:flex-start">

    {# ── Image column ── #}
    <div style="flex-shrink:0;width:200px">
      <div style="position:relative">
        <img id="sfd-image" src="" alt="" style="width:100%;border-radius:10px;display:block;box-shadow:0 4px 16px rgba(0,0,0,.4)">
        <div id="sfd-no-image" style="display:none;width:200px;aspect-ratio:63/88;background:var(--bs-tertiary-bg);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:3rem;color:var(--bs-secondary-color)">
          <i class="bi bi-card-image"></i>
        </div>
      </div>
      {# Prices below image #}
      <div style="margin-top:.85rem;display:flex;flex-direction:column;gap:.35rem">
        <div style="font-size:.8rem;display:flex;justify-content:space-between;padding:.3rem .5rem;background:var(--bs-tertiary-bg);border-radius:6px">
          <span class="text-muted">Market</span><strong id="sfd-usd">—</strong>
        </div>
        <div style="font-size:.8rem;display:flex;justify-content:space-between;padding:.3rem .5rem;background:var(--bs-tertiary-bg);border-radius:6px">
          <span class="text-muted">Foil</span><strong id="sfd-usd-foil">—</strong>
        </div>
      </div>
    </div>

    {# ── Info column ── #}
    <div style="flex:1;min-width:0">
      <div class="d-flex align-items-start justify-content-between gap-2 mb-3">
        <h4 id="sfd-name" class="mb-0 fw-bold" style="font-size:1.15rem;line-height:1.3"></h4>
        <button id="sfd-close" style="border:none;background:none;font-size:1.5rem;line-height:1;padding:.15rem .4rem;cursor:pointer;color:var(--bs-secondary-color);flex-shrink:0;border-radius:6px" title="Close">×</button>
      </div>

      <div class="d-flex gap-1 flex-wrap mb-3" id="sfd-badges"></div>

      <dl style="display:grid;grid-template-columns:auto 1fr;gap:.25rem .75rem;font-size:.85rem;margin-bottom:.75rem">
        <dt class="text-muted fw-normal" style="white-space:nowrap">Set</dt>
        <dd id="sfd-set" class="mb-0" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></dd>
        <dt class="text-muted fw-normal" style="white-space:nowrap">Type</dt>
        <dd id="sfd-type" class="mb-0"></dd>
        <dt id="sfd-mana-label" class="text-muted fw-normal" style="white-space:nowrap">Mana</dt>
        <dd id="sfd-mana" class="mb-0"></dd>
      </dl>

      <div style="border-top:1px solid var(--bs-border-color);padding-top:.75rem;margin-bottom:.85rem">
        <div class="text-muted" style="font-size:.72rem;font-weight:600;letter-spacing:.04em;margin-bottom:.4rem">ORACLE TEXT</div>
        <div id="sfd-oracle" style="font-size:.85rem;max-height:120px;overflow-y:auto;white-space:pre-wrap;line-height:1.55"></div>
      </div>

      {# ── Add to Box section ── #}
      <div style="border-top:1px solid var(--bs-border-color);padding-top:.85rem">
        <div class="text-muted mb-2" style="font-size:.72rem;font-weight:600;letter-spacing:.04em;text-transform:uppercase">Add to Box</div>
        <div class="d-flex gap-2 align-items-center flex-wrap">
          <input type="number" id="sfd-qty" class="form-control form-control-sm" style="width:72px" value="1" min="1" max="99">
          <div class="form-check mb-0">
            <input type="checkbox" id="sfd-foil" class="form-check-input">
            <label for="sfd-foil" class="form-check-label" style="font-size:.82rem">Foil</label>
          </div>
          <button id="sfd-add-btn" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-lg me-1"></i>Add to Box
          </button>
        </div>
        <div id="sfd-msg" style="font-size:.78rem;margin-top:.35rem;min-height:1.1em"></div>
      </div>
    </div>

  </div>
</dialog>

{% endblock %}

{% block scripts %}
<script>
const CSRF = document.querySelector('meta[name="csrf-token"]')?.content || '';

/* ── Effective price helper ────────────────────────────────────────────────── *
 * Returns the best available price for a card object:
 *   foil market → regular market → purchase price paid → null
 * ─────────────────────────────────────────────────────────────────────────── */
function _effectivePrice(card) {
  if (card.is_foil && card.usd_foil != null) return card.usd_foil;
  if (card.usd != null) return card.usd;
  if (card.purchase_price_usd != null) return card.purchase_price_usd;
  return null;
}

/* ── Price direction arrow ───────────────────────────────────────────────── */
function _priceArrow(direction) {
  if (direction === 'up')   return '<span style="color:#16a34a;font-size:.75em" title="Price up">↑</span>';
  if (direction === 'down') return '<span style="color:#dc2626;font-size:.75em" title="Price down">↓</span>';
  return '';
}

/* ── Open price history modal ───────────────────────────────────────────── */
function _showPriceHistory(scryfallId, cardName, e, isFoil) {
  if (e) { e.stopPropagation(); }
  if (typeof openPriceHistoryModal === 'function') {
    openPriceHistoryModal(scryfallId, cardName, !!isFoil);
  }
}

/* ── Tab switching ────────────────────────────────────────────────────────── */
function switchTab(tab) {
  ['collection','scryfall','all','value'].forEach(t => {
    document.getElementById('tab-' + t).style.display = (t === tab) ? '' : 'none';
    document.querySelectorAll('.search-tab').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tab);
    });
  });
  if (tab === 'all')        _loadAllCards();
  if (tab === 'collection') _loadMyCollection();
  if (tab === 'value')      _loadValueView();
}

/* ── Scryfall search ──────────────────────────────────────────────────────── */
const sfGrid  = document.getElementById('sfResultsGrid');
const sfSkel  = document.getElementById('sfSkelGrid');
const sfMeta  = document.getElementById('sfMeta');
const sfError = document.getElementById('sfError');
const sfEmpty = document.getElementById('sfEmpty');

// Format legalities into small pills
function legalityPills(legalities) {
  if (!legalities) return '';
  const fmts = ['standard','pioneer','modern','legacy','commander','vintage','pauper'];
  return fmts
    .filter(f => legalities[f] && legalities[f] !== 'not_legal')
    .slice(0, 4)
    .map(f => {
      const cls = legalities[f] === 'legal' ? 'leg-legal'
                : legalities[f] === 'banned' ? 'leg-banned' : 'leg-restricted';
      return `<span class="leg-pill ${cls}">${f.charAt(0).toUpperCase() + f.slice(1,3)}</span>`;
    }).join(' ');
}

async function runScryfallSearch() {
  const q   = document.getElementById('scryfallQuery').value.trim();
  const btn = document.getElementById('scryfallSearchBtn');
  if (!q) return;

  // Loading state
  sfGrid.innerHTML  = '';
  sfError.style.display = 'none';
  sfMeta.style.display  = 'none';
  sfEmpty.style.display = 'none';
  sfSkel.style.display  = '';
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Searching…';

  try {
    const res  = await fetch(`/cards/scryfall-search?q=${encodeURIComponent(q)}`);
    const data = await res.json();
    sfSkel.style.display = 'none';

    if (data.error) {
      sfError.textContent = data.error;
      sfError.style.display = '';
      return;
    }

    if (!data.cards || !data.cards.length) {
      sfEmpty.style.display = '';
      return;
    }

    sfMeta.textContent = `Showing ${data.cards.length} of ${data.total} result${data.total !== 1 ? 's' : ''}${data.has_more ? ' — refine your query for fewer results' : ''}`;
    sfMeta.style.display = '';

    data.cards.forEach(card => {
      const tile = document.createElement('div');
      tile.className = 'cs-tile sf-tile';
      tile.style.cursor = 'pointer';
      tile.title = 'Click for full card details';

      let legs = {};
      try { legs = JSON.parse(card.legalities || '{}'); } catch {}
      const pills = legalityPills(legs);

      const priceStr = card.usd != null ? `$${parseFloat(card.usd).toFixed(2)}` : (card.usd_foil != null ? `$${parseFloat(card.usd_foil).toFixed(2)}` : '—');

      tile.innerHTML = `
        <div class="cs-img-wrap">
          ${card.image_small
            ? `<img src="${card.image_small}" alt="${card.name}" loading="lazy">`
            : `<div class="cs-img-placeholder"><i class="bi bi-card-image"></i></div>`}
          <div class="cs-overlay">
            <div class="cs-ov-name">${card.name}</div>
            <div class="cs-ov-owner">${card.set_code || ''} ${card.set_name ? '· ' + card.set_name : ''}</div>
            ${pills ? `<div style="margin-top:.25rem">${pills}</div>` : ''}
            <div style="color:rgba(255,255,255,.65);font-size:.58rem;margin-top:.2rem">Click for details</div>
          </div>
        </div>
        <div class="cs-info">
          <div class="cs-name" title="${card.name}">${card.name}</div>
          <div class="cs-meta">${card.set_code || ''} · ${priceStr}</div>
        </div>`;

      // Store full card data on the tile element for the click handler
      tile._sfCard = card;
      tile.addEventListener('click', () => _openSFDetail(tile._sfCard));
      sfGrid.appendChild(tile);
    });

  } catch (err) {
    sfSkel.style.display  = 'none';
    sfError.textContent   = 'Network error. Please try again.';
    sfError.style.display = '';
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-globe2 me-1"></i>Search Scryfall';
  }
}

/* Enter key triggers Scryfall search */
document.getElementById('scryfallQuery')?.addEventListener('keydown', e => {
  if (e.key === 'Enter') runScryfallSearch();
});

/* ── Toast helper (still used by other parts of the page) ────────────────── */
function showToast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  el.style.cssText = 'bottom:1.5rem;right:1.5rem;z-index:9999;min-width:240px;max-width:380px';
  el.innerHTML = `${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

/* ── Scryfall card detail dialog ─────────────────────────────────────────── */
const _sfdDlg   = document.getElementById('sfDetailDlg');
let   _sfdCard  = null;

function _openSFDetail(card) {
  if (!card) return;
  _sfdCard = card;

  const img   = document.getElementById('sfd-image');
  const noImg = document.getElementById('sfd-no-image');
  const imgSrc = card.image_normal || card.image_small;
  if (imgSrc) {
    img.src = imgSrc;  img.alt = card.name;
    img.style.display   = '';
    noImg.style.display = 'none';
  } else {
    img.style.display   = 'none';
    noImg.style.display = 'flex';
  }

  document.getElementById('sfd-name').textContent = card.name;
  document.getElementById('sfd-usd').textContent      = card.usd      != null ? `$${parseFloat(card.usd).toFixed(2)}`      : '—';
  document.getElementById('sfd-usd-foil').textContent = card.usd_foil != null ? `$${parseFloat(card.usd_foil).toFixed(2)}` : '—';
  document.getElementById('sfd-set').textContent  = [card.set_code, card.set_name].filter(Boolean).join(' — ');
  document.getElementById('sfd-type').textContent = card.type_line || '';
  document.getElementById('sfd-oracle').innerHTML  = renderMana(card.oracle_text || '');

  const manaEl    = document.getElementById('sfd-mana');
  const manaLabel = document.getElementById('sfd-mana-label');
  if (card.mana_cost) {
    manaEl.innerHTML        = renderMana(card.mana_cost);
    manaEl.style.display    = '';
    manaLabel.style.display = '';
  } else {
    manaEl.style.display    = 'none';
    manaLabel.style.display = 'none';
  }

  // Rarity + legality badges
  const badges = document.getElementById('sfd-badges');
  const rarityColors = { mythic:'#e05c07', rare:'#a88b2e', uncommon:'#7c9db4', common:'#555' };
  const rarityHtml = card.rarity
    ? `<span class="badge" style="font-size:.72rem;padding:.3rem .6rem;background:${rarityColors[card.rarity]||'#555'};color:#fff">${card.rarity.charAt(0).toUpperCase()+card.rarity.slice(1)}</span>`
    : '';
  let legs = {};
  try { legs = JSON.parse(card.legalities || '{}'); } catch {}
  badges.innerHTML = rarityHtml + (legalityPills(legs) ? `<span style="margin-left:.25rem">${legalityPills(legs)}</span>` : '');

  // Reset Add-to-Box form
  document.getElementById('sfd-qty').value = 1;
  document.getElementById('sfd-foil').checked = false;
  document.getElementById('sfd-msg').textContent = '';
  document.getElementById('sfd-add-btn').disabled = false;
  document.getElementById('sfd-add-btn').innerHTML = '<i class="bi bi-plus-lg me-1"></i>Add to Box';

  _sfdDlg.showModal();
}

document.getElementById('sfd-close').addEventListener('click', () => _sfdDlg.close());
_sfdDlg.addEventListener('click', e => { if (e.target === _sfdDlg) _sfdDlg.close(); });

document.getElementById('sfd-add-btn').addEventListener('click', async function () {
  if (!_sfdCard) return;
  const qty    = Math.max(1, Math.min(parseInt(document.getElementById('sfd-qty').value) || 1, 99));
  const isFoil = document.getElementById('sfd-foil').checked;
  const btn    = this;
  const msg    = document.getElementById('sfd-msg');

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
  msg.textContent = '';

  try {
    const res  = await fetch('/cards/add-to-box', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
      body:    JSON.stringify({
        scryfall_id: _sfdCard.scryfall_id,
        name:        _sfdCard.name,
        qty,
        is_foil:     isFoil,
      }),
    });
    const data = await res.json();
    if (data.success) {
      msg.style.color = 'var(--bs-success)';
      msg.textContent = data.message;
      btn.innerHTML   = '✓ Added';
      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Add to Box';
        msg.textContent = '';
      }, 2200);
    } else {
      msg.style.color = 'var(--bs-danger)';
      msg.textContent = data.error || 'Failed to add card.';
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Add to Box';
    }
  } catch {
    msg.style.color = 'var(--bs-danger)';
    msg.textContent = 'Network error — try again.';
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Add to Box';
  }
});

// Auto-trigger Scryfall search if arriving on that tab with a query
{% if source == 'scryfall' and q %}
document.addEventListener('DOMContentLoaded', () => runScryfallSearch());
{% endif %}

/* ── My Collection tab ───────────────────────────────────────────────────── */
let _mcData  = null;   // null = not yet fetched
let _mcById  = {};

async function _loadMyCollection() {
  if (_mcData !== null) return;
  _mcData = [];

  const loading     = document.getElementById('mcLoading');
  const placeholder = document.getElementById('mcPlaceholder');
  const meta        = document.getElementById('mcMeta');

  placeholder.style.display = 'none';
  loading.style.display     = '';

  try {
    const res = await fetch('/api/cards/my-collection');
    if (!res.ok) throw new Error(res.status);
    _mcData = await res.json();
    _mcData.forEach(c => { _mcById[String(c.inv_id)] = c; });
    meta.textContent = `${_mcData.length} card${_mcData.length !== 1 ? 's' : ''}`;
    _buildLocationFilter();
    _renderMC(_mcData);
  } catch {
    loading.innerHTML = '<span class="text-danger">Failed to load — reload to retry.</span>';
    _mcData = null;
    return;
  }
  loading.style.display = 'none';
}

function _renderMC(cards) {
  const grid  = document.getElementById('mcGrid');
  const empty = document.getElementById('mcEmpty');
  if (!cards.length) {
    grid.innerHTML      = '';
    empty.style.display = '';
    return;
  }
  empty.style.display = 'none';
  grid.innerHTML = cards.map(card => {
    const _p  = _effectivePrice(card);
    const price = _p != null ? `$${_p.toFixed(2)}` : '—';
    const arrow = _priceArrow(card.price_direction);
    const imgSrc  = card.image_small || card.image;
    const imgHtml = imgSrc
      ? `<img src="${_esc(imgSrc)}" alt="${_esc(card.name)}" loading="lazy">`
      : `<div class="cs-img-placeholder"><i class="bi bi-card-image"></i></div>`;
    const foilOverlay = card.is_foil
      ? `<div style="position:absolute;inset:0;border-radius:9px 9px 0 0;background:linear-gradient(135deg,rgba(255,215,0,.0) 0%,rgba(255,215,0,.18) 30%,rgba(255,255,255,.12) 50%,rgba(180,0,255,.12) 70%,rgba(0,180,255,.0) 100%);pointer-events:none"></div>`
      : '';
    const foilBadge = card.is_foil
      ? `<span class="badge" style="font-size:.55rem;background:linear-gradient(135deg,#f59e0b,#a855f7);color:#fff">✦</span>`
      : '';
    const priceHtml = price !== '—'
      ? `<span class="cs-price-link" data-sid="${_esc(card.scryfall_id)}" data-name="${_esc(card.name)}" data-foil="${card.is_foil ? '1' : ''}" style="cursor:pointer;text-decoration:underline dotted;text-underline-offset:2px" title="View price history">${price}${arrow}</span>`
      : '—';
    return `<div class="cs-tile mc-tile" data-inv="${card.inv_id}" tabindex="0" role="button" aria-label="${_esc(card.name)}">
      <div class="cs-img-wrap">
        ${imgHtml}${foilOverlay}
        <div class="cs-badges">
          <span class="badge bg-dark bg-opacity-75" style="font-size:.6rem">×${card.quantity}</span>
          ${foilBadge}
        </div>
      </div>
      <div class="cs-info">
        <div class="cs-name" title="${_esc(card.name)}">${_esc(card.name)}</div>
        <div class="cs-meta">${_esc(card.set_code)}${price !== '—' ? ' · ' + priceHtml : ''}</div>
        <div class="cs-meta" style="color:var(--bs-primary);font-style:italic;overflow:hidden;white-space:nowrap;text-overflow:ellipsis">${_esc(card.location)}</div>
      </div>
    </div>`;
  }).join('');
}

/* Build physical location dropdown after data loads */
function _buildLocationFilter() {
  const sel = document.getElementById('mcLocationFilter');
  const locs = [...new Set(_mcData.map(c => c.physical_location).filter(Boolean))].sort();
  // Keep the "All Locations" option, remove old extras
  while (sel.options.length > 1) sel.remove(1);
  locs.forEach(loc => {
    const opt = document.createElement('option');
    opt.value = loc;
    opt.textContent = loc;
    sel.appendChild(opt);
  });
  sel.style.display = locs.length ? '' : 'none';
}

/* Live filter + Available checkbox + Location dropdown */
function _refilterMC() {
  if (_mcData === null || !_mcData.length) return;
  const q         = document.getElementById('mcSearch').value.toLowerCase().trim();
  const availOnly = document.getElementById('mcAvailable').checked;
  const locFilter = document.getElementById('mcLocationFilter').value;
  let filtered    = _mcData;
  if (q)         filtered = filtered.filter(c => c.name.toLowerCase().includes(q));
  if (availOnly) filtered = filtered.filter(c => c.location.endsWith('Box'));
  if (locFilter) filtered = filtered.filter(c => c.physical_location === locFilter);
  const cnt = filtered.length;
  document.getElementById('mcMeta').textContent =
    `${cnt} card${cnt !== 1 ? 's' : ''}` + (_mcData.length !== cnt ? ` of ${_mcData.length}` : '');
  _renderMC(filtered);
}
document.getElementById('mcSearch').addEventListener('input', _refilterMC);
document.getElementById('mcAvailable').addEventListener('change', _refilterMC);
document.getElementById('mcLocationFilter').addEventListener('change', _refilterMC);

/* Click / keyboard → shared detail dialog */
document.getElementById('mcGrid').addEventListener('click', function (e) {
  const priceLink = e.target.closest('.cs-price-link');
  if (priceLink) {
    e.stopPropagation();
    _showPriceHistory(priceLink.dataset.sid, priceLink.dataset.name, e, !!priceLink.dataset.foil);
    return;
  }
  const tile = e.target.closest('.mc-tile');
  if (tile) _openACD(_mcById[tile.dataset.inv]);
});
document.getElementById('mcGrid').addEventListener('keydown', function (e) {
  if (e.key !== 'Enter' && e.key !== ' ') return;
  const tile = e.target.closest('.mc-tile');
  if (!tile) return;
  e.preventDefault();
  _openACD(_mcById[tile.dataset.inv]);
});

{% if source == 'collection' %}
document.addEventListener('DOMContentLoaded', () => _loadMyCollection());
{% endif %}

/* ── All Cards tab ────────────────────────────────────────────────────────── */
let _acData  = null;   // null = not yet fetched; [] = loading/loaded
let _acById  = {};     // inv_id (string) → card object

function _esc(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function _loadAllCards() {
  if (_acData !== null) return;          // already loading or loaded
  _acData = [];                          // mark as in-progress

  const loading     = document.getElementById('allCardsLoading');
  const placeholder = document.getElementById('allCardsPlaceholder');
  const meta        = document.getElementById('allCardsMeta');

  placeholder.style.display = 'none';
  loading.style.display     = '';

  try {
    const res = await fetch('/api/cards/all-cards');
    if (!res.ok) throw new Error(res.status);
    _acData = await res.json();
    _acData.forEach(c => { _acById[String(c.inv_id)] = c; });
    meta.textContent = `${_acData.length} card${_acData.length !== 1 ? 's' : ''}`;
    _renderAC(_acData);
  } catch {
    loading.innerHTML = '<span class="text-danger">Failed to load cards — reload to retry.</span>';
    _acData = null;
    return;
  }
  loading.style.display = 'none';
}

function _renderAC(cards) {
  const grid  = document.getElementById('allCardsGrid');
  const empty = document.getElementById('allCardsEmpty');
  if (!cards.length) {
    grid.innerHTML        = '';
    empty.style.display   = '';
    return;
  }
  empty.style.display = 'none';
  grid.innerHTML = cards.map(card => {
    const _p  = _effectivePrice(card);
    const price = _p != null ? `$${_p.toFixed(2)}` : '—';
    const arrow = _priceArrow(card.price_direction);
    const imgSrc = card.image_small || card.image;
    const imgHtml = imgSrc
      ? `<img src="${_esc(imgSrc)}" alt="${_esc(card.name)}" loading="lazy">`
      : `<div class="cs-img-placeholder"><i class="bi bi-card-image"></i></div>`;
    const foilOverlay = card.is_foil
      ? `<div style="position:absolute;inset:0;border-radius:9px 9px 0 0;background:linear-gradient(135deg,rgba(255,215,0,.0) 0%,rgba(255,215,0,.18) 30%,rgba(255,255,255,.12) 50%,rgba(180,0,255,.12) 70%,rgba(0,180,255,.0) 100%);pointer-events:none"></div>`
      : '';
    const foilBadge = card.is_foil
      ? `<span class="badge" style="font-size:.55rem;background:linear-gradient(135deg,#f59e0b,#a855f7);color:#fff">✦</span>`
      : '';
    const priceHtml = price !== '—'
      ? `<span class="cs-price-link" data-sid="${_esc(card.scryfall_id)}" data-name="${_esc(card.name)}" data-foil="${card.is_foil ? '1' : ''}" style="cursor:pointer;text-decoration:underline dotted;text-underline-offset:2px" title="View price history">${price}${arrow}</span>`
      : '—';
    return `<div class="cs-tile ac-tile" data-inv="${card.inv_id}" tabindex="0" role="button" aria-label="${_esc(card.name)}">
      <div class="cs-img-wrap">
        ${imgHtml}${foilOverlay}
        <div class="cs-badges">
          <span class="badge bg-dark bg-opacity-75" style="font-size:.6rem">×${card.quantity}</span>
          ${foilBadge}
        </div>
      </div>
      <div class="cs-info">
        <div class="cs-name" title="${_esc(card.name)}">${_esc(card.name)}</div>
        <div class="cs-meta">${_esc(card.set_code)}${price !== '—' ? ' · ' + priceHtml : ''}</div>
        <div class="cs-meta" style="color:var(--bs-primary);font-style:italic;overflow:hidden;white-space:nowrap;text-overflow:ellipsis">${_esc(card.location)}</div>
      </div>
    </div>`;
  }).join('');
}

/* Live filter + Available checkbox */
function _refilterAC() {
  if (_acData === null || !_acData.length) return;
  const q         = document.getElementById('allCardsSearch').value.toLowerCase().trim();
  const availOnly = document.getElementById('allAvailable').checked;
  let filtered    = _acData;
  if (q)         filtered = filtered.filter(c => c.name.toLowerCase().includes(q));
  if (availOnly) filtered = filtered.filter(c => c.location.endsWith('Box'));
  const cnt = filtered.length;
  document.getElementById('allCardsMeta').textContent =
    `${cnt} card${cnt !== 1 ? 's' : ''}` + (_acData.length !== cnt ? ` of ${_acData.length}` : '');
  _renderAC(filtered);
}
document.getElementById('allCardsSearch').addEventListener('input', _refilterAC);
document.getElementById('allAvailable').addEventListener('change', _refilterAC);

/* Event delegation: click + keyboard on grid */
document.getElementById('allCardsGrid').addEventListener('click', function (e) {
  const priceLink = e.target.closest('.cs-price-link');
  if (priceLink) {
    e.stopPropagation();
    _showPriceHistory(priceLink.dataset.sid, priceLink.dataset.name, e, !!priceLink.dataset.foil);
    return;
  }
  const tile = e.target.closest('.ac-tile');
  if (tile) _openACD(_acById[tile.dataset.inv]);
});
document.getElementById('allCardsGrid').addEventListener('keydown', function (e) {
  if (e.key !== 'Enter' && e.key !== ' ') return;
  const tile = e.target.closest('.ac-tile');
  if (!tile) return;
  e.preventDefault();
  _openACD(_acById[tile.dataset.inv]);
});

/* Detail dialog */
const _acdDlg = document.getElementById('allCardsDlg');
let   _acdCard = null;    // card currently shown in dialog
let   _myDecks = null;    // null = not yet fetched

async function _loadDecks() {
  if (_myDecks !== null) return;
  _myDecks = [];
  try {
    const r = await fetch('/api/cards/my-decks');
    if (r.ok) _myDecks = await r.json();
  } catch { /* keep empty */ }
}

function _openACD(card) {
  if (!card) return;
  _acdCard = card;

  const img     = document.getElementById('acd-image');
  const noImg   = document.getElementById('acd-no-image');
  const shimmer = document.getElementById('acd-foil-shimmer');

  if (card.image) {
    img.src = card.image;  img.alt = card.name;
    img.style.display   = '';
    noImg.style.display = 'none';
  } else {
    img.style.display   = 'none';
    noImg.style.display = 'flex';
  }
  shimmer.style.display = card.is_foil ? '' : 'none';

  document.getElementById('acd-name').textContent = card.name;

  const locBadge = document.getElementById('acd-location-badge');
  locBadge.textContent      = card.location;
  locBadge.style.background = card.location.startsWith('Your') ? 'var(--bs-primary)' : '#6b7280';
  locBadge.style.color      = '#fff';

  const rarityColors = { mythic:'#e05c07', rare:'#a88b2e', uncommon:'#7c9db4', common:'#555' };
  const rb = document.getElementById('acd-rarity-badge');
  rb.textContent      = card.rarity ? card.rarity.charAt(0).toUpperCase() + card.rarity.slice(1) : '';
  rb.style.background = rarityColors[card.rarity] || '#555';
  rb.style.color      = '#fff';

  document.getElementById('acd-set').textContent  = [card.set_code, card.set_name].filter(Boolean).join(' — ');
  document.getElementById('acd-type').textContent = card.type_line || '';
  const manaEl    = document.getElementById('acd-mana');
  const manaLabel = document.getElementById('acd-mana-label');
  if (card.mana_cost) {
    manaEl.innerHTML        = renderMana(card.mana_cost);
    manaEl.style.display    = '';
    manaLabel.style.display = '';
  } else {
    manaEl.style.display    = 'none';
    manaLabel.style.display = 'none';
  }
  document.getElementById('acd-oracle').innerHTML      = renderMana(card.oracle_text || '');
  document.getElementById('acd-usd').textContent       = card.usd      != null ? `$${card.usd.toFixed(2)}`      : '—';
  document.getElementById('acd-usd-foil').textContent  = card.usd_foil != null ? `$${card.usd_foil.toFixed(2)}` : '—';
  document.getElementById('acd-qty').textContent       = `${card.quantity}${card.is_foil ? ' ✦' : ''}`;

  /* ── Add to Deck section: only for own Box cards ── */
  const addSection = document.getElementById('acd-add-section');
  document.getElementById('acd-add-msg').textContent = '';
  if (card.location === 'Your Box') {
    addSection.style.display = '';
    const qtyEl = document.getElementById('acd-add-qty');
    qtyEl.max   = card.quantity;
    qtyEl.value = 1;
    _loadDecks().then(() => {
      const sel = document.getElementById('acd-deck-select');
      sel.innerHTML = _myDecks.length
        ? _myDecks.map(d => `<option value="${d.id}">${_esc(d.name)} (${_esc(d.format)})</option>`).join('')
        : '<option value="">— No decks yet —</option>';
      document.getElementById('acd-add-btn').disabled = !_myDecks.length;
    });
  } else {
    addSection.style.display = 'none';
  }

  _acdDlg.showModal();
}

document.getElementById('acd-close').addEventListener('click', () => _acdDlg.close());
_acdDlg.addEventListener('click', e => { if (e.target === _acdDlg) _acdDlg.close(); });

/* ── Add to Deck handler ─────────────────────────────────────────────────── */
document.getElementById('acd-add-btn').addEventListener('click', async function () {
  if (!_acdCard) return;
  const deckId = parseInt(document.getElementById('acd-deck-select').value);
  const qty    = Math.max(1, Math.min(
    parseInt(document.getElementById('acd-add-qty').value) || 1,
    _acdCard.quantity,
  ));
  const btn = this;
  const msg = document.getElementById('acd-add-msg');

  if (!deckId) { msg.style.color = 'var(--bs-danger)'; msg.textContent = 'Select a deck first.'; return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
  msg.textContent = '';

  try {
    const res  = await fetch(`/decks/${deckId}/add-card`, {
      method:  'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
      body:    JSON.stringify({ inv_id: _acdCard.inv_id, qty }),
    });
    const data = await res.json();
    if (data.success) {
      msg.style.color = 'var(--bs-success)';
      msg.textContent = data.message;
      /* Update local qty or remove card from datasets */
      const remaining = _acdCard.quantity - qty;
      if (remaining <= 0) {
        const id = String(_acdCard.inv_id);
        if (_acData) _acData = _acData.filter(c => c.inv_id !== _acdCard.inv_id);
        if (_mcData) _mcData = _mcData.filter(c => c.inv_id !== _acdCard.inv_id);
        delete _acById[id];
        delete _mcById[id];
        _refilterAC();
        _refilterMC();
        setTimeout(() => _acdDlg.close(), 900);
      } else {
        _acdCard.quantity = remaining;
        const id = String(_acdCard.inv_id);
        if (_acById[id]) _acById[id].quantity = remaining;
        if (_mcById[id]) _mcById[id].quantity = remaining;
        document.getElementById('acd-qty').textContent = `${remaining}${_acdCard.is_foil ? ' ✦' : ''}`;
        document.getElementById('acd-add-qty').max   = remaining;
        document.getElementById('acd-add-qty').value = Math.min(qty, remaining);
        _refilterAC();
        _refilterMC();
      }
    } else {
      msg.style.color = 'var(--bs-danger)';
      msg.textContent = data.error || 'Could not add card.';
    }
  } catch {
    msg.style.color = 'var(--bs-danger)';
    msg.textContent = 'Network error — try again.';
  }
  btn.disabled = false;
  btn.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Add';
});

{% if source == 'all' %}
document.addEventListener('DOMContentLoaded', () => _loadAllCards());
{% endif %}

/* ── Collection Value tab ───────────────────────────────────────────────── */
let _valData = null;   // null = not fetched

async function _loadValueView() {
  if (_valData !== null) return;
  _valData = [];

  const loading     = document.getElementById('valueLoading');
  const placeholder = document.getElementById('valuePlaceholder');

  placeholder.style.display = 'none';
  loading.style.display     = '';

  try {
    const res = await fetch('/api/cards/my-collection');
    if (!res.ok) throw new Error(res.status);
    const all = await res.json();

    /* Sort: priced cards descending by per-card value, unpriced at the bottom */
    const priced   = [];
    const unpriced = [];
    all.forEach(c => {
      if (c.is_proxy) return;   // proxies carry no monetary value
      const p = _effectivePrice(c);
      if (p != null) priced.push({ ...c, _price: p });
      else           unpriced.push({ ...c, _price: null });
    });
    priced.sort((a, b) => b._price - a._price);
    _valData = [...priced, ...unpriced];

    const cnt = all.length;
    document.getElementById('valueMeta').textContent =
      `${cnt} card${cnt !== 1 ? 's' : ''}`;
    _renderValue(_valData);
  } catch {
    loading.innerHTML = '<span class="text-danger">Failed to load — reload to retry.</span>';
    _valData = null;
    return;
  }
  loading.style.display = 'none';
}

function _renderValue(cards) {
  const list  = document.getElementById('valueList');
  const empty = document.getElementById('valueEmpty');

  if (!cards.length) {
    list.innerHTML      = '';
    empty.style.display = '';
    return;
  }
  empty.style.display = 'none';

  let rank = 0;
  list.innerHTML = cards.map(card => {
    const p        = card._price;
    const priceStr = p != null ? `$${p.toFixed(2)}` : '—';
    const totalVal = p != null ? p * card.quantity : null;
    const totalStr = totalVal != null && card.quantity > 1 ? `$${totalVal.toFixed(2)} total` : '';
    const imgSrc   = card.image_small || card.image;
    if (p != null) rank++;
    const rankStr = p != null ? `#${rank}` : '';

    const foilShimmer = card.is_foil
      ? `<div style="position:absolute;inset:0;border-radius:10px 10px 0 0;background:linear-gradient(135deg,rgba(255,215,0,.0) 0%,rgba(255,215,0,.18) 30%,rgba(255,255,255,.12) 50%,rgba(180,0,255,.12) 70%,rgba(0,180,255,.0) 100%);pointer-events:none"></div>`
      : '';
    const foilBadge = card.is_foil
      ? `<span style="font-size:.55rem;padding:.1rem .3rem;border-radius:3px;background:linear-gradient(135deg,#f59e0b,#a855f7);color:#fff;font-weight:700">✦</span>`
      : '';

    return `<div class="val-card" data-inv="${card.inv_id}" role="button" tabindex="0" aria-label="${_esc(card.name)}">
      <div class="val-card-img-wrap">
        ${imgSrc
          ? `<img src="${_esc(imgSrc)}" alt="${_esc(card.name)}" loading="lazy">`
          : `<div class="val-card-img-ph"><i class="bi bi-card-image"></i></div>`}
        ${foilShimmer}
        ${rankStr ? `<span class="val-card-rank">${rankStr}</span>` : ''}
        ${card.quantity > 1 ? `<span class="val-card-qty">×${card.quantity}</span>` : ''}
      </div>
      <div class="val-card-info">
        <div class="val-card-price" style="${p == null ? 'color:var(--bs-secondary-color);font-size:.85rem;font-weight:500' : ''}">${priceStr}</div>
        ${totalStr ? `<div class="val-card-total">${totalStr}</div>` : ''}
        <div class="val-card-name">${_esc(card.name)} ${foilBadge}</div>
        <div class="val-card-sub">${_esc(card.set_code)} — ${_esc(card.location)}</div>
      </div>
    </div>`;
  }).join('');
}

function _refilterValue() {
  if (!_valData) return;
  const q = document.getElementById('valueSearch').value.toLowerCase().trim();
  const filtered = q ? _valData.filter(c => c.name.toLowerCase().includes(q)) : _valData;
  const cnt = filtered.length;
  document.getElementById('valueMeta').textContent =
    `${cnt} card${cnt !== 1 ? 's' : ''}` + (_valData.length !== cnt ? ` of ${_valData.length}` : '');
  _renderValue(filtered);
}
document.getElementById('valueSearch').addEventListener('input', _refilterValue);

/* Click on a value card opens the shared detail dialog */
document.getElementById('valueList').addEventListener('click', function (e) {
  const card = e.target.closest('.val-card');
  if (!card) return;
  const invId = parseInt(card.dataset.inv);
  const data  = _valData && _valData.find(c => c.inv_id === invId);
  if (data) _openACD(data);
});
document.getElementById('valueList').addEventListener('keydown', function (e) {
  if (e.key !== 'Enter' && e.key !== ' ') return;
  const card = e.target.closest('.val-card');
  if (!card) return;
  e.preventDefault();
  const invId = parseInt(card.dataset.inv);
  const data  = _valData && _valData.find(c => c.inv_id === invId);
  if (data) _openACD(data);
});

{% if source == 'value' %}
document.addEventListener('DOMContentLoaded', () => _loadValueView());
{% endif %}
</script>
{% endblock %}
