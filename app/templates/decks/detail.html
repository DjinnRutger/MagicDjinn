{% extends "base.html" %}
{% block title %}{{ deck.name }} — {{ get_setting('app_name', 'MagicDjinn') }}{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<style>
/* ── Format badge colours ──────────────────────────────────────────────────── */
.fmt-Commander  { background:#7c3aed; color:#fff }
.fmt-Standard   { background:#2563eb; color:#fff }
.fmt-Pioneer    { background:#0891b2; color:#fff }
.fmt-Modern     { background:#d97706; color:#fff }
.fmt-Legacy     { background:#dc2626; color:#fff }
.fmt-Vintage    { background:#854d0e; color:#fff }
.fmt-Pauper     { background:#16a34a; color:#fff }
.fmt-Casual     { background:#6b7280; color:#fff }
.fmt-Other      { background:#6b7280; color:#fff }

/* ── Color pips ────────────────────────────────────────────────────────────── */
.color-pip {
  display: inline-block; width: 15px; height: 15px;
  border-radius: 50%; border: 1px solid rgba(0,0,0,.25);
  flex-shrink: 0;
}
.pip-W { background:#f9faf4; }
.pip-U { background:#0e68ab; }
.pip-B { background:#211c20; }
.pip-R { background:#d42126; }
.pip-G { background:#00773c; }

/* ── Card grid ─────────────────────────────────────────────────────────────── */
.card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(8.1rem, 1fr));
  gap: .85rem;
}
.card-tile {
  position: relative; border-radius: 10px; overflow: hidden;
  aspect-ratio: 63/88; cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,.25);
  transition: transform .2s, box-shadow .2s;
  background: var(--bs-tertiary-bg);
  outline: 2px solid transparent; outline-offset: 2px;
}
.card-tile:hover  { transform: translateY(-5px) scale(1.04); box-shadow: 0 8px 20px rgba(0,0,0,.4); }
.card-tile:focus  { outline-color: var(--primary, #2563eb); }
.card-tile img    { width: 100%; height: 100%; object-fit: cover; display: block; }
.card-tile .qty-badge {
  position: absolute; top: 5px; right: 5px;
  background: rgba(0,0,0,.75); color:#fff;
  font-size: .7rem; font-weight: 700; padding: 2px 6px;
  border-radius: 4px; line-height: 1.3;
}
.card-tile .foil-badge {
  position: absolute; top: 5px; left: 5px;
  background: linear-gradient(135deg,#f59e0b,#ec4899,#8b5cf6);
  color:#fff; font-size: .58rem; font-weight: 700;
  padding: 2px 5px; border-radius: 4px; line-height: 1.3;
}
.card-tile .cover-badge {
  position: absolute; bottom: 5px; left: 5px;
  background: rgba(37,99,235,.85); color:#fff;
  font-size: .58rem; font-weight: 700;
  padding: 2px 5px; border-radius: 4px; line-height: 1.3;
}
.card-tile .sb-badge {
  position: absolute; bottom: 5px; right: 5px;
  background: rgba(107,114,128,.85); color:#fff;
  font-size: .58rem; font-weight: 700;
  padding: 2px 5px; border-radius: 4px; line-height: 1.3;
}
.card-tile .cmd-badge {
  position: absolute; bottom: 5px; right: 5px;
  background: rgba(217,119,6,.9); color:#fff;
  font-size: .58rem; font-weight: 700;
  padding: 2px 5px; border-radius: 4px; line-height: 1.3;
}
.card-tile .proxy-badge {
  position: absolute; top: 28px; left: 5px;
  background: rgba(75,85,99,.9); color:#fff;
  font-size: .55rem; font-weight: 700;
  padding: 2px 5px; border-radius: 4px; line-height: 1.3;
  letter-spacing: .03em;
}
.card-tile[data-hidden="1"] { display: none; }

/* ── Stat cards ────────────────────────────────────────────────────────────── */
.stat-card {
  border: 1px solid var(--bs-border-color);
  border-radius: 10px;
  padding: .85rem 1.1rem;
  background: var(--bs-tertiary-bg);
  display: flex; align-items: center; gap: .75rem;
}
.stat-card .stat-icon { font-size: 1.4rem; opacity: .7; }
.stat-card .stat-val  { font-size: 1.15rem; font-weight: 700; line-height: 1.1; }
.stat-card .stat-lbl  { font-size: .72rem; color: var(--bs-secondary-color); }

/* ── Add-cards modal ───────────────────────────────────────────────────────── */
dialog#addCardsDialog {
  border: none; border-radius: 14px; padding: 0; width: min(700px, 95vw);
  box-shadow: 0 20px 60px rgba(0,0,0,.4);
  background: var(--bs-body-bg); color: var(--bs-body-color);
}
dialog#addCardsDialog::backdrop { background: rgba(0,0,0,.55); }

/* ── Import dialog ─────────────────────────────────────────────────────────── */
dialog#importDialog {
  border: none; border-radius: 14px; padding: 0; width: min(620px, 96vw);
  box-shadow: 0 20px 60px rgba(0,0,0,.4);
  background: var(--bs-body-bg); color: var(--bs-body-color);
}
dialog#importDialog::backdrop { background: rgba(0,0,0,.55); }

.modal-header-custom {
  display: flex; align-items: center; justify-content: space-between;
  padding: 1rem 1.25rem .75rem;
  border-bottom: 1px solid var(--bs-border-color);
}
.box-card-list {
  max-height: 380px; overflow-y: auto;
  padding: .5rem .75rem;
}
.box-card-row {
  display: flex; align-items: center; gap: .75rem;
  padding: .5rem .5rem;
  border-radius: 8px; cursor: pointer;
  transition: background .15s;
  border-bottom: 1px solid var(--bs-border-color);
}
.box-card-row:last-child { border-bottom: none; }
.box-card-row:hover { background: var(--bs-tertiary-bg); }
.box-card-row.selected { background: rgba(37,99,235,.12); }
.box-card-thumb {
  width: 38px; height: 53px; object-fit: cover;
  border-radius: 4px; flex-shrink: 0;
  background: var(--bs-tertiary-bg);
}
.box-card-info { flex: 1; min-width: 0; }
.box-card-name { font-weight: 600; font-size: .88rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.box-card-meta { font-size: .72rem; color: var(--bs-secondary-color); }
</style>
{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb mb-0">
  <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Home</a></li>
  <li class="breadcrumb-item"><a href="{{ url_for('decks.index') }}">My Decks</a></li>
  <li class="breadcrumb-item active">{{ deck.name }}</li>
</ol>
{% endblock %}

{% block page_header %}
<div class="page-header d-flex align-items-start justify-content-between flex-wrap gap-2">
  <div>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <h1 class="mb-0">{{ deck.name }}</h1>
      <span class="badge fmt-{{ deck.format | replace(' ','') }}" style="font-size:.7rem;vertical-align:middle">
        {{ deck.format }}
      </span>
      {% if deck.bracket %}
      <span class="badge" style="background:#374151;color:#fff;font-size:.7rem" title="MTG Power Level Bracket">
        <i class="bi bi-bar-chart-fill me-1"></i>B{{ deck.bracket }}
      </span>
      {% endif %}
      {% if deck.is_visible_to_friends %}
      <i class="bi bi-eye-fill text-info" title="Visible to friends" style="font-size:.85rem"></i>
      {% endif %}
    </div>
    {% if deck.description %}
    <p class="text-muted mt-1 mb-0" style="font-size:.88rem">{{ deck.description }}</p>
    {% endif %}
    {# Color identity pips #}
    {% set ci = deck.color_identity or '' %}
    <div class="d-flex gap-1 align-items-center mt-2">
      {% for c in ['W','U','B','R','G'] %}
        {% if c in ci %}
        <span class="color-pip pip-{{ c }}" title="{{ {'W':'White','U':'Blue','B':'Black','R':'Red','G':'Green'}[c] }}"></span>
        {% endif %}
      {% endfor %}
      {% if ci == '' %}
      <span class="text-muted" style="font-size:.75rem">Colorless</span>
      {% endif %}
    </div>
  </div>
  <div class="d-flex gap-2 flex-wrap">
    {% if can_edit %}
    <button class="btn btn-primary" onclick="document.getElementById('addCardsDialog').showModal()">
      <i class="bi bi-plus-lg me-1"></i>Add Cards
    </button>
    <button class="btn btn-outline-primary" onclick="openImportDialog()">
      <i class="bi bi-box-arrow-in-down me-1"></i>Import
    </button>
    {% endif %}
    {% if is_owner %}
    <a href="{{ url_for('decks.edit_deck', deck_id=deck.id) }}" class="btn btn-outline-secondary">
      <i class="bi bi-pencil me-1"></i>Edit
    </a>
    <form method="post" action="{{ url_for('decks.delete_deck', deck_id=deck.id) }}"
          onsubmit="return confirm('Delete this deck? All cards will be returned to your Box.')">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-outline-danger">
        <i class="bi bi-trash3"></i>
      </button>
    </form>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block content %}

{# ── Stats row ─────────────────────────────────────────────────────────────── #}
<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="stat-card">
      <i class="bi bi-collection-fill text-primary stat-icon"></i>
      <div>
        <div class="stat-val">{{ total_qty }}</div>
        <div class="stat-lbl">Total Cards</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card">
      <i class="bi bi-layers-fill text-info stat-icon"></i>
      <div>
        <div class="stat-val">{{ deck_cards | length }}</div>
        <div class="stat-lbl">Unique Slots</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card">
      <i class="bi bi-currency-dollar text-success stat-icon"></i>
      <div>
        <div class="stat-val">{{ deck.display_value }}</div>
        <div class="stat-lbl">Est. Value</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card">
      <i class="bi bi-clock text-secondary stat-icon"></i>
      <div>
        <div class="stat-val">{{ deck.updated_at.strftime('%b %d') }}</div>
        <div class="stat-lbl">Last Updated</div>
      </div>
    </div>
  </div>
</div>

{# ── Live search bar ────────────────────────────────────────────────────────── #}
<div class="d-flex gap-2 mb-3 align-items-center flex-wrap">
  <div class="input-group" style="max-width:320px">
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input type="search" id="deckSearch" placeholder="Filter cards…"
           class="form-control" autocomplete="off"
           value="{{ search }}"
           oninput="filterDeckCards(this.value)">
  </div>
  <span class="text-muted ms-auto" style="font-size:.82rem" id="deckCardCount">
    {{ deck_cards | length }} slot{% if deck_cards | length != 1 %}s{% endif %}
    · {{ total_qty }} card{% if total_qty != 1 %}s{% endif %}
  </span>
</div>

{# ── Macro: render a grid of inventory cards ──────────────────────────────── #}
{% macro card_grid(cards, section) %}
<div class="card-grid" data-section="{{ section }}">
  {% for inv in cards %}
  {% set card = inv.card %}
  {% set cd = {
    'inv_id':         inv.id,
    'name':           card.name or '',
    'image':          card.image_normal or card.image_small or '',
    'set_code':       card.set_code or '',
    'set_name':       card.set_name or '',
    'collector_num':  card.collector_number or '',
    'type_line':      card.type_line or '',
    'oracle_text':    card.oracle_text or '',
    'mana_cost':      card.mana_cost or '',
    'rarity':         card.rarity or '',
    'scryfall_id':    card.scryfall_id or '',
    'usd':            card.usd,
    'usd_foil':       card.usd_foil,
    'quantity':       inv.quantity,
    'is_foil':        inv.is_foil,
    'is_proxy':       inv.is_proxy,
    'is_sideboard':   inv.is_sideboard,
    'is_commander':   inv.is_commander,
    'condition':         inv.condition.value,
    'purchase_price':    inv.purchase_price_usd,
    'notes':             inv.notes or '',
    'physical_location': inv.physical_location or '',
  } %}
  <div class="card-tile"
       tabindex="0"
       role="button"
       aria-label="{{ card.name }}"
       data-card-name="{{ card.name | lower }}"
       data-card='{{ cd | tojson }}'>
    {% if card.image_normal or card.image_small %}
    <img src="{{ card.image_normal or card.image_small }}" alt="{{ card.name }}" loading="lazy">
    {% else %}
    <div class="d-flex align-items-center justify-content-center h-100 p-2">
      <span class="text-muted text-center" style="font-size:.75rem">{{ card.name }}</span>
    </div>
    {% endif %}
    <div class="qty-badge">×{{ inv.quantity }}</div>
    {% if inv.is_foil %}<div class="foil-badge">FOIL</div>{% endif %}
    {% if inv.is_proxy %}<div class="proxy-badge">PROXY</div>{% endif %}
    {% if deck.cover_card_scryfall_id and card.scryfall_id == deck.cover_card_scryfall_id %}
    <div class="cover-badge"><i class="bi bi-image"></i> Cover</div>
    {% endif %}
    {% if inv.is_commander %}<div class="cmd-badge"><i class="bi bi-crown"></i> CMD</div>{% endif %}
    {% if inv.is_sideboard %}<div class="sb-badge">SB</div>{% endif %}
  </div>
  {% endfor %}
</div>
{% endmacro %}

{# ── Mainboard ──────────────────────────────────────────────────────────────── #}
{% if mainboard %}
{{ card_grid(mainboard, 'mainboard') }}
{% elif not sideboard %}
<div class="text-center py-5" id="emptyState">
  <i class="bi bi-layers" style="font-size:3rem;opacity:.25"></i>
  <h5 class="mt-3 fw-semibold" id="emptyMsg">
    {% if search %}No cards match "{{ search }}"{% else %}No cards in this deck yet{% endif %}
  </h5>
  <p class="text-muted">
    {% if search %}
    Try a different search term.
    {% elif can_edit %}
    Click <strong>Add Cards</strong> or <strong>Import</strong> above to add cards to this deck.
    {% else %}
    This deck has no cards yet.
    {% endif %}
  </p>
</div>
{% endif %}

{# ── Sideboard (collapsible, shown only if cards present) ─────────────────── #}
{% if sideboard %}
<div class="mt-4" id="sideboardSection">
  <button class="btn btn-sm btn-outline-secondary mb-2"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#sideboardCollapse"
          aria-expanded="false"
          aria-controls="sideboardCollapse">
    <i class="bi bi-collection me-1"></i>
    Sideboard ({{ sideboard | sum(attribute='quantity') }} cards,
    {{ sideboard | length }} slot{% if sideboard | length != 1 %}s{% endif %})
    <i class="bi bi-chevron-down ms-1" style="font-size:.7rem"></i>
  </button>
  <div class="collapse" id="sideboardCollapse">
    {{ card_grid(sideboard, 'sideboard') }}
  </div>
</div>
{% endif %}

{# ── Add Cards Dialog (owner / shared users only) ──────────────────────────── #}
{% if can_edit %}
<dialog id="addCardsDialog">
  <div class="modal-header-custom">
    <div>
      <h5 class="mb-0 fw-bold">Add Cards from Box</h5>
      <small class="text-muted">Select a card, choose quantity, confirm.</small>
    </div>
    <button type="button" class="btn-close" onclick="document.getElementById('addCardsDialog').close()"></button>
  </div>

  <div style="padding:.75rem 1.25rem .5rem">
    <input type="search" id="boxSearch" class="form-control form-control-sm"
           placeholder="Filter by name…" oninput="filterBoxCards(this.value)">
  </div>

  <div class="box-card-list" id="boxCardList"></div>

  <div style="padding:.75rem 1.25rem; border-top:1px solid var(--bs-border-color); display:flex; gap:.75rem; align-items:center">
    <div style="flex:1">
      <span id="selectedCardName" class="text-muted" style="font-size:.85rem">No card selected</span>
    </div>
    <div class="d-flex align-items-center gap-2">
      <label style="font-size:.82rem;white-space:nowrap">Qty:</label>
      <input type="number" id="addQtyInput" min="1" max="99" value="1"
             class="form-control form-control-sm" style="width:65px">
    </div>
    <button id="confirmAddBtn" class="btn btn-primary btn-sm" disabled onclick="confirmAddCard()">
      <i class="bi bi-plus-lg me-1"></i>Add to Deck
    </button>
  </div>
</dialog>

{# ── Import More Dialog ─────────────────────────────────────────────────────── #}
<dialog id="importDialog">
  <div class="modal-header-custom">
    <div>
      <h5 class="mb-0 fw-bold"><i class="bi bi-box-arrow-in-down me-2 text-primary"></i>Import Cards into Deck</h5>
      <small class="text-muted">Paste a decklist or Moxfield export to add more cards.</small>
    </div>
    <button type="button" class="btn-close" onclick="document.getElementById('importDialog').close()"></button>
  </div>
  <div style="padding:1rem 1.25rem">
    <form id="importForm" novalidate>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      {# Import type toggle #}
      <div class="d-flex gap-3 flex-wrap mb-3">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="import_type" id="imp_decklist"
                 value="decklist" checked onchange="updateImportDialogUI()">
          <label class="form-check-label" for="imp_decklist">Paste decklist</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="import_type" id="imp_moxfield"
                 value="moxfield" onchange="updateImportDialogUI()">
          <label class="form-check-label" for="imp_moxfield">Moxfield export (paste)</label>
        </div>
      </div>

      <div id="imp-decklist-section" class="mb-3">
        <label class="form-label form-label-sm">Decklist</label>
        <textarea name="decklist_text" class="form-control font-monospace" rows="10"
                  style="font-size:.82rem"
                  placeholder="4 Lightning Bolt (LEA)&#10;4 Counterspell&#10;1 Black Lotus (LEA) 232&#10;// qty name (SET) collector#"></textarea>
      </div>

      <div id="imp-moxfield-section" class="mb-3" style="display:none">
        <label class="form-label form-label-sm">Moxfield export</label>
        <textarea name="moxfield_text" class="form-control font-monospace" rows="10"
                  style="font-size:.82rem"
                  placeholder="Paste the text from Moxfield → Export → Text"></textarea>
        <div class="form-text">Sideboard cards are automatically detected from the Moxfield sections.</div>
      </div>
    </form>
  </div>
  <div style="padding:.75rem 1.25rem; border-top:1px solid var(--bs-border-color); display:flex; gap:.75rem; justify-content:flex-end">
    <button type="button" class="btn btn-outline-secondary btn-sm"
            onclick="document.getElementById('importDialog').close()">Cancel</button>
    <button type="button" class="btn btn-primary btn-sm" id="startImportBtn" onclick="startDeckImport()">
      <i class="bi bi-box-arrow-in-down me-1"></i>Import Cards
    </button>
  </div>
</dialog>

{# ── Import progress overlay ────────────────────────────────────────────────── #}
<div id="deckImportOverlay"
     class="d-none position-fixed top-0 start-0 end-0 bottom-0"
     style="background:rgba(0,0,0,.55);z-index:1055">
  <div class="d-flex h-100 align-items-center justify-content-center px-3">
    <div class="card shadow-lg" style="min-width:340px;max-width:480px;width:100%">
      <div class="card-header d-flex align-items-center gap-2">
        <div class="spinner-border spinner-border-sm text-primary" id="impProgressSpinner"></div>
        <strong id="impProgressTitle" class="text-truncate">Importing cards…</strong>
      </div>
      <div class="card-body pb-3">
        <div class="progress mb-2" style="height:8px">
          <div class="progress-bar progress-bar-striped progress-bar-animated"
               id="impProgressBar" role="progressbar" style="width:0%"></div>
        </div>
        <div class="d-flex justify-content-between" style="font-size:.82rem">
          <span id="impProgressCard" class="text-muted text-truncate pe-2">Starting…</span>
          <span id="impProgressCount" class="fw-semibold flex-shrink-0"></span>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

{# ── Card detail modal (shared component) ─────────────────────────────────── #}
{% include "components/card_modal.html" %}

{# ── Price History Modal ──────────────────────────────────────────────────── #}
{% include "components/price_history_modal.html" %}

{% endblock %}

{% block scripts %}
<script>
const DECK_ID          = {{ deck.id }};
const DECK_FORMAT      = {{ deck.format | tojson }};
const IS_COMMANDER_FMT = DECK_FORMAT === 'Commander';
const CAN_EDIT         = {{ 'true' if can_edit else 'false' }};
const CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]')?.content || '';
var   COVER_SID  = {{ (deck.cover_card_scryfall_id | tojson) if deck.cover_card_scryfall_id else 'null' }};
window._onCoverSidChange = function(newSid) { COVER_SID = newSid; };
const BOX_DATA = {{ box_data | tojson }};

/* ── Toast helper ────────────────────────────────────────────────────────── */
function showToast(msg, type) {
  type = type || 'success';
  var el = document.createElement('div');
  el.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed';
  el.style.cssText = 'bottom:1.5rem;right:1.5rem;z-index:9999;min-width:240px;max-width:380px';
  el.innerHTML = msg + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
  document.body.appendChild(el);
  setTimeout(function() { el.remove(); }, 3500);
}
window._pageToast = showToast;

/* ── Live card search ────────────────────────────────────────────────────── */
function filterDeckCards(query) {
  var q = query.trim().toLowerCase();
  var visible = 0;
  document.querySelectorAll('.card-tile').forEach(function(tile) {
    var name = tile.dataset.cardName || '';
    var show = !q || name.includes(q);
    tile.dataset.hidden = show ? '0' : '1';
    tile.style.display  = show ? '' : 'none';
    if (show) visible++;
  });
  var countEl = document.getElementById('deckCardCount');
  if (countEl && q) countEl.textContent = visible + ' match' + (visible !== 1 ? 'es' : '');
  else if (countEl) countEl.textContent = '{{ deck_cards | length }} slot{% if deck_cards | length != 1 %}s{% endif %} · {{ total_qty }} card{% if total_qty != 1 %}s{% endif %}';
}

/* ── Card modal for deck cards ───────────────────────────────────────────── */
var cardModalDlg = document.getElementById('cardModal');
var cardModalClose = document.getElementById('cardModalClose');
var _currentInvId = null;

function openDeckCardModal(tile) {
  var rawData = tile.getAttribute('data-card');
  if (!rawData) return;
  var card;
  try { card = JSON.parse(rawData); } catch(e) { return; }

  _currentInvId = card.inv_id;
  cardModalDlg.dataset.scryfallId = card.scryfall_id || '';

  document.getElementById('modal-card-name').textContent   = card.name || '—';
  document.getElementById('modal-card-set').textContent    =
    (card.set_code || '') + (card.set_name ? ' — ' + card.set_name : '');
  document.getElementById('modal-mana-cost').innerHTML    = renderMana(card.mana_cost || '');
  document.getElementById('modal-type-line').textContent  = card.type_line || '';
  document.getElementById('modal-oracle-text').innerHTML  = renderMana(card.oracle_text || '');

  document.getElementById('modal-price-usd').textContent  =
    card.usd  != null ? '$' + parseFloat(card.usd).toFixed(2)       : 'N/A';
  document.getElementById('modal-price-foil').textContent =
    card.usd_foil != null ? '$' + parseFloat(card.usd_foil).toFixed(2) : 'N/A';

  var rb = document.getElementById('modal-rarity-badge');
  var rarityColors = { mythic:'#e05c07', rare:'#a88b2e', uncommon:'#7c9db4', common:'#555' };
  rb.textContent   = (card.rarity || '').charAt(0).toUpperCase() + (card.rarity || '').slice(1);
  rb.style.background = rarityColors[card.rarity] || '#555';
  rb.style.color = '#fff';

  var img     = document.getElementById('modal-card-image');
  var shimmer = document.getElementById('modal-foil-shimmer');
  if (card.image) { img.src = card.image; img.alt = card.name; img.style.display = ''; }
  else { img.style.display = 'none'; }
  shimmer.style.display = card.is_foil ? '' : 'none';

  document.getElementById('modal-qty').value               = card.quantity || 1;
  document.getElementById('modal-is-foil').checked         = !!card.is_foil;
  document.getElementById('modal-is-proxy').checked        = !!card.is_proxy;
  document.getElementById('modal-condition').value         = card.condition || 'NM';
  document.getElementById('modal-purchase-price').value    = card.purchase_price != null ? card.purchase_price : '';
  document.getElementById('modal-physical-location').value = card.physical_location || '';
  document.getElementById('modal-notes').value             = card.notes || '';

  document.getElementById('modal-alert').style.display = 'none';

  if (CAN_EDIT) {
    if (window._showDeckModalSection) {
      window._showDeckModalSection(DECK_ID, COVER_SID, card.inv_id, CSRF_TOKEN, {
        is_sideboard:        !!card.is_sideboard,
        is_commander:        !!card.is_commander,
        is_commander_format: IS_COMMANDER_FMT,
      });
    }
    // Enable all edit controls
    document.getElementById('modal-edit-section').querySelectorAll('input,select,textarea,button').forEach(function(el) {
      el.disabled = false;
    });
  } else {
    // View-only: hide deck section, disable all edit controls
    if (window._hideDeckModalSection) window._hideDeckModalSection();
    document.getElementById('modal-edit-section').querySelectorAll('input,select,textarea,button').forEach(function(el) {
      el.disabled = true;
    });
    // Show read-only notice
    var al = document.getElementById('modal-alert');
    al.innerHTML = '<div class="alert alert-secondary py-1 mb-0" style="font-size:.8rem"><i class="bi bi-lock me-1"></i>Read-only view — you can\'t edit this card.</div>';
    al.style.display = '';
  }

  cardModalDlg.showModal();
}

// Wire up all card tiles
document.querySelectorAll('.card-tile').forEach(function(tile) {
  tile.addEventListener('click', function() { openDeckCardModal(tile); });
  tile.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openDeckCardModal(tile); }
  });
});

// Close on backdrop click
cardModalDlg.addEventListener('click', function(e) {
  if (e.target === cardModalDlg) cardModalDlg.close();
});
cardModalClose.addEventListener('click', function() { cardModalDlg.close(); _currentInvId = null; });

/* ── Save (qty, condition, foil, notes) ──────────────────────────────────── */
document.getElementById('modal-save-btn').addEventListener('click', function() {
  if (!_currentInvId || !CAN_EDIT) return;
  var btn = this;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving…';
  document.getElementById('modal-alert').style.display = 'none';

  var payload = {
    quantity:           parseInt(document.getElementById('modal-qty').value) || 1,
    is_foil:            document.getElementById('modal-is-foil').checked,
    is_proxy:           document.getElementById('modal-is-proxy').checked,
    condition:          document.getElementById('modal-condition').value,
    purchase_price_usd: document.getElementById('modal-purchase-price').value || null,
    physical_location:  document.getElementById('modal-physical-location').value,
    notes:              document.getElementById('modal-notes').value,
    is_sideboard:       document.getElementById('modal-is-sideboard').checked,
    is_commander:       IS_COMMANDER_FMT && document.getElementById('modal-is-commander').checked,
  };
  if (window._modalSelectedPrintingId &&
      window._modalSelectedPrintingId !== window._modalOriginalPrintingId) {
    payload.card_scryfall_id = window._modalSelectedPrintingId;
  }

  fetch('/box/' + _currentInvId + '/edit', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
    body: JSON.stringify(payload),
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.success) {
      var al = document.getElementById('modal-alert');
      al.innerHTML = '<div class="alert alert-success py-1 mb-0" style="font-size:.8rem">' + (data.message || 'Saved!') + '</div>';
      al.style.display = '';
      setTimeout(function() { window.location.reload(); }, 800);
    } else {
      var al = document.getElementById('modal-alert');
      al.innerHTML = '<div class="alert alert-danger py-1 mb-0" style="font-size:.8rem">' + (data.error || 'Could not save.') + '</div>';
      al.style.display = '';
    }
  })
  .catch(function() {
    var al = document.getElementById('modal-alert');
    al.innerHTML = '<div class="alert alert-danger py-1 mb-0" style="font-size:.8rem">Network error.</div>';
    al.style.display = '';
  })
  .finally(function() {
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Save Changes';
  });
});

{% if can_edit %}
/* ── Box card list rendering ──────────────────────────────────────────────── */
var selectedInvId   = null;
var selectedMaxQty  = 1;
var filteredBoxData = BOX_DATA.slice();

function renderBoxList(data) {
  var list = document.getElementById('boxCardList');
  if (!data.length) {
    list.innerHTML = '<p class="text-muted text-center py-3" style="font-size:.85rem">Your Box is empty or no matches found.</p>';
    return;
  }
  list.innerHTML = data.map(function(item) {
    return '<div class="box-card-row' + (item.inv_id === selectedInvId ? ' selected' : '') + '"'
      + ' data-inv-id="' + item.inv_id + '"'
      + ' data-max-qty="' + item.quantity + '"'
      + ' data-name="' + item.name.replace(/"/g,'&quot;') + '"'
      + ' onclick="selectBoxCard(this)">'
      + (item.image ? '<img src="' + item.image + '" class="box-card-thumb" alt="">' : '<div class="box-card-thumb"></div>')
      + '<div class="box-card-info">'
      + '<div class="box-card-name">' + item.name + '</div>'
      + '<div class="box-card-meta">'
      + (item.set_code ? item.set_code.toUpperCase() + ' · ' : '')
      + 'Qty: ' + item.quantity
      + (item.is_foil ? ' · <span style="color:#f59e0b">Foil</span>' : '')
      + '</div></div></div>';
  }).join('');
}

function filterBoxCards(query) {
  var q = query.toLowerCase();
  filteredBoxData = q ? BOX_DATA.filter(function(i) { return i.name.toLowerCase().includes(q); }) : BOX_DATA.slice();
  renderBoxList(filteredBoxData);
}

function selectBoxCard(row) {
  document.querySelectorAll('.box-card-row.selected').forEach(function(r) { r.classList.remove('selected'); });
  row.classList.add('selected');
  selectedInvId  = parseInt(row.dataset.invId);
  selectedMaxQty = parseInt(row.dataset.maxQty);
  document.getElementById('selectedCardName').textContent = row.dataset.name;
  var qtyInput = document.getElementById('addQtyInput');
  qtyInput.max   = selectedMaxQty;
  qtyInput.value = Math.min(parseInt(qtyInput.value) || 1, selectedMaxQty);
  document.getElementById('confirmAddBtn').disabled = false;
}

document.getElementById('addCardsDialog').addEventListener('close', function() {
  selectedInvId  = null;
  selectedMaxQty = 1;
  document.getElementById('selectedCardName').textContent = 'No card selected';
  document.getElementById('confirmAddBtn').disabled = true;
  document.getElementById('boxSearch').value = '';
  filteredBoxData = BOX_DATA.slice();
  renderBoxList(filteredBoxData);
});

renderBoxList(BOX_DATA);

/* ── Add card to deck ─────────────────────────────────────────────────────── */
async function confirmAddCard() {
  if (!selectedInvId) return;
  var qty = parseInt(document.getElementById('addQtyInput').value) || 1;
  var btn = document.getElementById('confirmAddBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

  try {
    var res = await fetch('/decks/' + DECK_ID + '/add-card', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
      body: JSON.stringify({ inv_id: selectedInvId, qty: qty }),
    });
    var data = await res.json();
    if (res.ok && data.success) {
      showToast(data.message, 'success');
      document.getElementById('addCardsDialog').close();
      setTimeout(function() { location.reload(); }, 800);
    } else {
      showToast(data.error || 'Failed to add card.', 'danger');
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Add to Deck';
    }
  } catch(err) {
    showToast('Network error.', 'danger');
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Add to Deck';
  }
}

/* ── Import dialog ────────────────────────────────────────────────────────── */
function openImportDialog() {
  // Reset form
  document.querySelector('#importForm input[value="decklist"]').checked = true;
  document.querySelectorAll('#importForm textarea').forEach(function(ta) { ta.value = ''; });
  updateImportDialogUI();
  document.getElementById('importDialog').showModal();
}

function updateImportDialogUI() {
  var val = document.querySelector('#importForm input[name="import_type"]:checked');
  var type = val ? val.value : 'decklist';
  document.getElementById('imp-decklist-section').style.display = type === 'decklist' ? '' : 'none';
  document.getElementById('imp-moxfield-section').style.display = type === 'moxfield' ? '' : 'none';
}

function startDeckImport() {
  var form       = document.getElementById('importForm');
  var importType = document.querySelector('#importForm input[name="import_type"]:checked');
  if (!importType) return;

  var formData = new FormData(form);

  document.getElementById('importDialog').close();
  var overlay = document.getElementById('deckImportOverlay');
  overlay.classList.remove('d-none');
  overlay.style.display = 'flex';

  fetch('/decks/' + DECK_ID + '/import-stream', {
    method: 'POST',
    body: formData,
  }).then(function(resp) {
    if (!resp.ok) { setImportError('Server error (' + resp.status + ')'); return; }
    var reader  = resp.body.getReader();
    var decoder = new TextDecoder();
    var buffer  = '';

    function pump() {
      reader.read().then(function(chunk) {
        if (chunk.done) return;
        buffer += decoder.decode(chunk.value, { stream: true });
        var lines = buffer.split('\n');
        buffer = lines.pop();
        lines.forEach(function(line) {
          if (line.trim()) {
            try { handleImportEvent(JSON.parse(line)); } catch(ex) {}
          }
        });
        pump();
      }).catch(function() { setImportError('Connection lost'); });
    }
    pump();
  }).catch(function() { setImportError('Network error'); });
}

function handleImportEvent(evt) {
  var bar     = document.getElementById('impProgressBar');
  var count   = document.getElementById('impProgressCount');
  var card    = document.getElementById('impProgressCard');
  var title   = document.getElementById('impProgressTitle');
  var spinner = document.getElementById('impProgressSpinner');

  if (evt.type === 'start') {
    count.textContent = '0 / ' + (evt.total || 0);
    card.textContent  = 'Looking up cards on Scryfall…';
  } else if (evt.type === 'progress') {
    var pct = evt.total > 0 ? Math.round((evt.current / evt.total) * 100) : 50;
    bar.style.width   = pct + '%';
    count.textContent = evt.current + ' / ' + evt.total;
    card.textContent  = (evt.ok ? '✓ ' : '✗ ') + evt.card;
  } else if (evt.type === 'done') {
    bar.style.width = '100%';
    bar.classList.remove('progress-bar-animated', 'progress-bar-striped');
    spinner.style.display = 'none';
    var msg = 'Done';
    if (evt.successes) msg += ' — ' + evt.successes + ' card(s) imported';
    if (evt.failures)  msg += ', ' + evt.failures + ' failed';
    title.textContent = msg;
    card.textContent  = 'Reloading…';
    if (evt.redirect_url) setTimeout(function() { window.location.href = evt.redirect_url; }, 900);
  } else if (evt.type === 'error') {
    setImportError(evt.message);
  }
}

function setImportError(msg) {
  document.getElementById('impProgressBar').classList.add('bg-danger');
  document.getElementById('impProgressBar').classList.remove('progress-bar-animated', 'progress-bar-striped');
  document.getElementById('impProgressSpinner').style.display = 'none';
  document.getElementById('impProgressTitle').textContent = 'Error: ' + msg;
  document.getElementById('impProgressCard').textContent  = 'You may close and try again.';
  // Re-show the import dialog so user can fix and retry
  setTimeout(function() {
    document.getElementById('deckImportOverlay').classList.add('d-none');
    document.getElementById('importDialog').showModal();
  }, 2000);
}
{% endif %}
</script>
{% endblock %}
