{% extends "base.html" %}
{% block title %}My Collection — {{ get_setting('app_name', 'MagicDjinn') }}{% endblock %}

{% block head %}
<style>
/* ── MTG Card Grid ────────────────────────────────────────────────────────── */
/* rem units inherit root font-size, so tiles grow with the ui_scale setting */
.mtg-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(8.1rem, 1fr)); gap: 0.85rem; }
@media (max-width: 576px) { .mtg-grid { grid-template-columns: repeat(auto-fill, minmax(6.25rem, 1fr)); gap: 0.6rem; } }

.mtg-card-tile {
  cursor: pointer;
  border-radius: 9px;
  transition: transform .2s, box-shadow .2s;
  outline: 2px solid transparent;
  outline-offset: 2px;
}
.mtg-card-tile:hover  { transform: translateY(-5px) scale(1.03); box-shadow: 0 12px 28px rgba(0,0,0,.35); z-index: 5; position: relative; }
.mtg-card-tile:focus  { outline-color: var(--primary); }

.mtg-card-img-wrap {
  position: relative;
  aspect-ratio: 63 / 88;
  background: var(--bs-tertiary-bg);
  border-radius: 9px;
  overflow: hidden;
}
.mtg-card-img {
  width: 100%; height: 100%;
  object-fit: cover;
  display: block;
  border-radius: 9px;
}
.mtg-card-img-placeholder {
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
  font-size: 2.5rem; color: var(--bs-secondary-color);
}
.mtg-card-badges {
  position: absolute; top: 5px; right: 5px;
  display: flex; flex-direction: column; gap: 3px; align-items: flex-end;
}
.mtg-foil-shimmer {
  position: absolute; inset: 0; border-radius: 9px;
  background: linear-gradient(135deg,rgba(255,215,0,.0) 0%,rgba(255,215,0,.18) 30%,rgba(255,255,255,.12) 50%,rgba(180,0,255,.12) 70%,rgba(0,180,255,.0) 100%);
  pointer-events: none;
}
.mtg-card-info { padding: 5px 3px 3px; }
.mtg-card-name {
  font-size: .7rem; font-weight: 600;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  line-height: 1.3;
}
.mtg-card-meta { font-size: .63rem; color: var(--bs-secondary-color); margin-top: 2px; }

/* ── Search / filter toolbar ──────────────────────────────────────────────── */
.collection-toolbar {
  display: flex; flex-wrap: wrap; gap: .6rem;
  align-items: center; margin-bottom: 1.25rem;
}
.collection-toolbar .input-group { flex: 1; min-width: 200px; max-width: 360px; }
.collection-stats {
  font-size: .82rem; color: var(--bs-secondary-color);
  margin-left: auto; white-space: nowrap;
}
</style>
{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb mb-0">
  <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Home</a></li>
  <li class="breadcrumb-item active">My Collection</li>
</ol>
{% endblock %}

{% block page_header %}
<div class="page-header d-flex align-items-center justify-content-between flex-wrap gap-2">
  <div>
    <h1>My Collection</h1>
    <p class="lead mb-0">Your Box — cards not assigned to a deck</p>
  </div>
  <a href="{{ url_for('collection.import_cards') }}" class="btn btn-primary">
    <i class="bi bi-cloud-download me-1"></i>Import Cards
  </a>
</div>
{% endblock %}

{% block content %}

{# ── Toolbar ── #}
<form method="get" action="{{ url_for('collection.box') }}" class="collection-toolbar">
  <div class="input-group">
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input type="text" name="q" class="form-control" placeholder="Search cards…"
           value="{{ search }}" autocomplete="off">
    {% if search %}
    <a href="{{ url_for('collection.box') }}" class="btn btn-outline-secondary" title="Clear search">
      <i class="bi bi-x"></i>
    </a>
    {% endif %}
  </div>

  <select name="sort" class="form-select form-select-sm" style="width:auto" onchange="this.form.submit()">
    <option value="name"   {% if sort == 'name'   %}selected{% endif %}>A–Z</option>
    <option value="value"  {% if sort == 'value'  %}selected{% endif %}>Highest value</option>
    <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest first</option>
    <option value="rarity" {% if sort == 'rarity' %}selected{% endif %}>Rarity</option>
  </select>

  <div class="form-check form-check-inline mb-0">
    <input type="checkbox" name="foil" value="1" id="foilFilter" class="form-check-input"
           {% if foil_only %}checked{% endif %} onchange="this.form.submit()">
    <label for="foilFilter" class="form-check-label" style="font-size:.85rem">Foil only</label>
  </div>

  <div class="collection-stats">
    <strong>{{ total_qty }}</strong> card{% if total_qty != 1 %}s{% endif %}
    &nbsp;·&nbsp;
    <strong>${{ "%.2f"|format(total_value) }}</strong> est. value
    {% if search %}
    &nbsp;·&nbsp;<em class="text-muted">filtered</em>
    {% endif %}
  </div>
</form>

{# ── Card grid ── #}
{% if items %}
<div class="mtg-grid" id="cardGrid">
  {% for inv in items %}
  {% set cd = {
    'inv_id':         inv.id,
    'name':           inv.card.name or '',
    'image':          inv.card.image_normal or '',
    'set_code':       inv.card.set_code or '',
    'set_name':       inv.card.set_name or '',
    'collector_num':  inv.card.collector_number or '',
    'type_line':      inv.card.type_line or '',
    'oracle_text':    inv.card.oracle_text or '',
    'mana_cost':      inv.card.mana_cost or '',
    'rarity':         inv.card.rarity or '',
    'scryfall_id':    inv.card.scryfall_id or '',
    'usd':            inv.card.usd,
    'usd_foil':       inv.card.usd_foil,
    'quantity':       inv.quantity,
    'is_foil':        inv.is_foil,
    'condition':      inv.condition.value,
    'purchase_price':     inv.purchase_price_usd,
    'notes':              inv.notes or '',
    'physical_location':  inv.physical_location or '',
  } %}
  <div class="mtg-card-tile"
       tabindex="0"
       role="button"
       aria-label="{{ inv.card.name }}"
       data-card='{{ cd | tojson }}'>
    <div class="mtg-card-img-wrap">
      {% if inv.card.image_normal %}
      <img src="{{ inv.card.image_normal }}"
           alt="{{ inv.card.name }}"
           class="mtg-card-img"
           loading="lazy">
      {% else %}
      <div class="mtg-card-img-placeholder">
        <i class="bi bi-card-image"></i>
      </div>
      {% endif %}
      {% if inv.is_foil %}<div class="mtg-foil-shimmer"></div>{% endif %}
      <div class="mtg-card-badges">
        <span class="badge bg-dark bg-opacity-75 text-white" style="font-size:.6rem">{{ inv.quantity }}×</span>
        {% if inv.is_foil %}
        <span class="badge" style="font-size:.55rem;background:linear-gradient(135deg,#f59e0b,#a855f7);color:#fff">✦ Foil</span>
        {% endif %}
      </div>
    </div>
    <div class="mtg-card-info">
      <div class="mtg-card-name">{{ inv.card.name }}</div>
      <div class="mtg-card-meta">
        {% if inv.is_foil and inv.card.usd_foil %}${{ "%.2f"|format(inv.card.usd_foil) }}
        {% elif inv.card.usd %}${{ "%.2f"|format(inv.card.usd) }}
        {% else %}—{% endif %}
        · {{ inv.condition.value }}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% else %}
<div class="text-center py-5">
  <i class="bi bi-collection" style="font-size:3rem;opacity:.25"></i>
  <h5 class="mt-3 fw-semibold">
    {% if search %}No cards match "{{ search }}"
    {% else %}Your Box is empty{% endif %}
  </h5>
  <p class="text-muted">
    {% if search %}
    <a href="{{ url_for('collection.box') }}">Clear filter</a> or
    {% endif %}
    <a href="{{ url_for('collection.import_cards') }}">import cards</a> to get started.
  </p>
</div>
{% endif %}

{# ── Card modal ── #}
{% include "components/card_modal.html" %}

{% endblock %}


{% block scripts %}
<script>
(function () {
  var dlg       = document.getElementById("cardModal");
  window._hideDeckModalSection && window._hideDeckModalSection();
  var closeBtn  = document.getElementById("cardModalClose");
  var csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");

  // ── State ──────────────────────────────────────────────────────────────────
  var currentInvId = null;

  // ── Open ───────────────────────────────────────────────────────────────────
  function openCardModal(tile) {
    var rawData = tile.getAttribute("data-card");
    if (!rawData) return;
    var card;
    try { card = JSON.parse(rawData); } catch(e) { return; }

    currentInvId = card.inv_id;

    // Store scryfall_id for the Printings tab lazy-loader
    dlg.dataset.scryfallId = card.scryfall_id || '';

    // Populate text fields
    document.getElementById("modal-card-name").textContent   = card.name || "—";
    document.getElementById("modal-card-set").textContent    =
      (card.set_code ? card.set_code : "") + (card.set_name ? " — " + card.set_name : "");
    document.getElementById("modal-mana-cost").innerHTML    = renderMana(card.mana_cost || "");
    document.getElementById("modal-type-line").textContent  = card.type_line || "";
    document.getElementById("modal-oracle-text").innerHTML  = renderMana(card.oracle_text || "");

    // Prices (shown in Price tab)
    document.getElementById("modal-price-usd").textContent  =
      card.usd  != null ? "$" + card.usd.toFixed(2)       : "N/A";
    document.getElementById("modal-price-foil").textContent =
      card.usd_foil != null ? "$" + card.usd_foil.toFixed(2) : "N/A";
    var upd = document.getElementById("modal-price-updated");
    if (upd) upd.textContent = card.last_updated ? "Updated " + card.last_updated : "";

    // Rarity badge
    var rb = document.getElementById("modal-rarity-badge");
    var rarityColors = { mythic:"#e05c07", rare:"#a88b2e", uncommon:"#7c9db4", common:"#555" };
    rb.textContent = (card.rarity || "").charAt(0).toUpperCase() + (card.rarity || "").slice(1);
    rb.style.background = rarityColors[card.rarity] || "#555";
    rb.style.color = "#fff";

    // Image + foil shimmer
    var img     = document.getElementById("modal-card-image");
    var shimmer = document.getElementById("modal-foil-shimmer");
    if (card.image) {
      img.src = card.image;
      img.alt = card.name;
      img.style.display = "";
    } else {
      img.style.display = "none";
    }
    shimmer.style.display = card.is_foil ? "" : "none";

    // Edit fields
    document.getElementById("modal-qty").value             = card.quantity || 1;
    document.getElementById("modal-is-foil").checked       = !!card.is_foil;
    document.getElementById("modal-condition").value       = card.condition || "NM";
    document.getElementById("modal-purchase-price").value    = card.purchase_price != null ? card.purchase_price : "";
    document.getElementById("modal-physical-location").value = card.physical_location || "";
    document.getElementById("modal-notes").value             = card.notes || "";

    hideAlert();
    dlg.showModal();
  }

  // ── Close ──────────────────────────────────────────────────────────────────
  function closeModal() { dlg.close(); currentInvId = null; }

  closeBtn.addEventListener("click", closeModal);
  dlg.addEventListener("click", function(e) {
    if (e.target === dlg) closeModal();
  });

  // ── Click any card tile ────────────────────────────────────────────────────
  document.querySelectorAll(".mtg-card-tile").forEach(function(tile) {
    tile.addEventListener("click", function() { openCardModal(tile); });
    tile.addEventListener("keydown", function(e) {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openCardModal(tile); }
    });
  });

  // ── Alert helpers ──────────────────────────────────────────────────────────
  function showAlert(msg, type) {
    var el = document.getElementById("modal-alert");
    el.innerHTML = '<div class="alert alert-' + type + ' py-2 mb-0" style="font-size:.8rem">' + msg + '</div>';
    el.style.display = "";
  }
  function hideAlert() { document.getElementById("modal-alert").style.display = "none"; }

  // ── Save ───────────────────────────────────────────────────────────────────
  document.getElementById("modal-save-btn").addEventListener("click", function() {
    if (!currentInvId) return;
    var btn = this;
    btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving…';
    hideAlert();

    var payload = {
      quantity:           parseInt(document.getElementById("modal-qty").value) || 1,
      is_foil:            document.getElementById("modal-is-foil").checked,
      condition:          document.getElementById("modal-condition").value,
      purchase_price_usd: document.getElementById("modal-purchase-price").value || null,
      physical_location:  document.getElementById("modal-physical-location").value,
      notes:              document.getElementById("modal-notes").value,
    };
    // Include new printing id only if the user actually changed the edition/variant
    if (window._modalSelectedPrintingId &&
        window._modalSelectedPrintingId !== window._modalOriginalPrintingId) {
      payload.card_scryfall_id = window._modalSelectedPrintingId;
    }

    fetch("/box/" + currentInvId + "/edit", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
      body: JSON.stringify(payload),
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        showAlert(data.message || "Saved!", "success");
        // Update the tile badge in the grid without full reload
        var tile = document.querySelector('.mtg-card-tile[data-inv-id="' + currentInvId + '"]');
        // Reload page after brief delay so grid refreshes
        setTimeout(function() { window.location.reload(); }, 800);
      } else {
        showAlert(data.error || "Could not save.", "danger");
      }
    })
    .catch(function() { showAlert("Network error. Try again.", "danger"); })
    .finally(function() {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Save Changes';
    });
  });

  // ── Delete ─────────────────────────────────────────────────────────────────
  document.getElementById("modal-delete-btn").addEventListener("click", function() {
    if (!currentInvId) return;
    if (!confirm("Remove this card from your Box? This cannot be undone.")) return;
    var btn = this;
    btn.disabled = true;

    fetch("/box/" + currentInvId + "/delete", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        closeModal();
        window.location.reload();
      } else {
        alert(data.error || "Could not delete card.");
        btn.disabled = false;
      }
    })
    .catch(function() { alert("Network error."); btn.disabled = false; });
  });

})();
</script>
{% endblock %}
