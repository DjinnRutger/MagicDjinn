{% extends "base.html" %}
{% block title %}{{ friend.username }}'s Decks — {{ get_setting('app_name', 'MagicDjinn') }}{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb mb-0">
  <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Home</a></li>
  <li class="breadcrumb-item"><a href="{{ url_for('friends.index') }}">Friends</a></li>
  <li class="breadcrumb-item">
    <a href="{{ url_for('friends.friend_box', user_id=friend.id) }}">{{ friend.username }}</a>
  </li>
  <li class="breadcrumb-item active">Decks</li>
</ol>
{% endblock %}

{% block page_header %}
<div class="page-header d-flex align-items-center justify-content-between flex-wrap gap-2">
  <div>
    <h1><i class="bi bi-layers me-2 text-primary"></i>{{ friend.username }}'s Decks</h1>
    <p class="lead mb-0">
      {{ decks | length }} public deck{% if decks | length != 1 %}s{% endif %}
    </p>
  </div>
  <div class="d-flex gap-2">
    <a href="{{ url_for('friends.friend_box', user_id=friend.id) }}" class="btn btn-outline-secondary">
      <i class="bi bi-collection me-1"></i>View Box
    </a>
    <a href="{{ url_for('friends.index') }}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>Back
    </a>
  </div>
</div>
{% endblock %}

{% block head %}
<style>
/* ── Format badge colours ─────────────────────────────────────────────────── */
.fmt-Commander { background:#7c3aed;color:#fff }
.fmt-Standard  { background:#2563eb;color:#fff }
.fmt-Pioneer   { background:#0891b2;color:#fff }
.fmt-Modern    { background:#d97706;color:#fff }
.fmt-Legacy    { background:#dc2626;color:#fff }
.fmt-Vintage   { background:#854d0e;color:#fff }
.fmt-Pauper    { background:#16a34a;color:#fff }
.fmt-Casual    { background:#6b7280;color:#fff }
.fmt-Other     { background:#6b7280;color:#fff }

/* ── Color pips ────────────────────────────────────────────────────────────── */
.color-pip {
  display:inline-block; width:13px; height:13px;
  border-radius:50%; border:1px solid rgba(0,0,0,.25); flex-shrink:0;
}
.pip-W{background:#f9faf4} .pip-U{background:#0e68ab} .pip-B{background:#211c20}
.pip-R{background:#d42126} .pip-G{background:#00773c}

/* ── Deck grid ─────────────────────────────────────────────────────────────── */
.deck-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(15rem, 1fr));
  gap: 1rem;
}
.deck-cover-img {
  width: 100%; aspect-ratio: 63/88; object-fit: cover;
  display: block; border-bottom: 1px solid var(--bs-border-color);
}
.deck-cover-placeholder {
  width: 100%; aspect-ratio: 63/44;
  background: var(--bs-tertiary-bg);
  display: flex; align-items: center; justify-content: center;
  border-bottom: 1px solid var(--bs-border-color);
}
.deck-card {
  display: flex; flex-direction: column;
  border: 1px solid var(--bs-border-color);
  border-radius: 10px; overflow: hidden;
  background: var(--bs-body-bg);
  transition: box-shadow .2s, transform .15s;
  text-decoration: none; color: inherit;
}
.deck-card:hover { box-shadow: 0 8px 24px rgba(0,0,0,.18); transform: translateY(-3px); }
.deck-card-header {
  padding: .85rem 1rem .6rem;
  border-bottom: 1px solid var(--bs-border-color);
  background: var(--bs-tertiary-bg);
}
.deck-card-name { font-size: 1rem; font-weight: 700; line-height: 1.2; }
.deck-card-body { padding: .75rem 1rem; flex: 1; }
.deck-card-footer {
  padding: .6rem 1rem;
  border-top: 1px solid var(--bs-border-color);
  display: flex; align-items: center; gap: .5rem;
}
.deck-stat { display: flex; align-items: center; gap: .35rem; font-size: .82rem; }

/* Shared badge on card footer */
.shared-badge {
  background: rgba(37,99,235,.12); color: #2563eb;
  border: 1px solid rgba(37,99,235,.3);
  font-size: .68rem; font-weight: 600; padding: 2px 6px;
  border-radius: 4px;
}
</style>
{% endblock %}

{% block content %}

{% if decks %}
<div class="deck-grid">
  {% for deck in decks %}
  {% set ci = deck.color_identity or '' %}

  <a href="{{ url_for('friends.friend_deck_detail', deck_id=deck.id) }}" class="deck-card">

    {# Cover card image — full portrait like own deck list #}
    {% if deck.cover_card_image %}
    <img src="{{ deck.cover_card_image }}" alt="{{ deck.name }}" class="deck-cover-img" loading="lazy">
    {% else %}
    <div class="deck-cover-placeholder">
      <i class="bi bi-layers-fill" style="font-size:2.6rem;color:var(--bs-secondary-color);opacity:.25"></i>
    </div>
    {% endif %}

    <div class="deck-card-header">
      <div class="d-flex align-items-start justify-content-between gap-2 mb-1">
        <div class="deck-card-name">{{ deck.name }}</div>
        <div class="d-flex gap-1 flex-shrink-0">
          <span class="badge fmt-{{ deck.format | replace(' ','') }}" style="font-size:.65rem">{{ deck.format }}</span>
          {% if deck.bracket %}
          <span class="badge" style="background:#374151;color:#fff;font-size:.65rem" title="Bracket {{ deck.bracket }}">B{{ deck.bracket }}</span>
          {% endif %}
        </div>
      </div>
      <div class="d-flex gap-1 align-items-center">
        {% for c in ['W','U','B','R','G'] %}
          {% if c in ci %}
          <span class="color-pip pip-{{ c }}"
                title="{{ {'W':'White','U':'Blue','B':'Black','R':'Red','G':'Green'}[c] }}"></span>
          {% endif %}
        {% endfor %}
        {% if ci == '' %}
        <span class="text-muted" style="font-size:.72rem">Colorless</span>
        {% endif %}
      </div>
    </div>

    <div class="deck-card-body">
      {% if deck.description %}
      <p class="text-muted mb-2" style="font-size:.8rem;line-height:1.4">
        {{ deck.description | truncate(100) }}
      </p>
      {% endif %}
      <div class="d-flex gap-3 flex-wrap">
        <div class="deck-stat">
          <i class="bi bi-collection text-primary"></i>
          <span><strong>{{ deck.total_quantity }}</strong> cards</span>
        </div>
        <div class="deck-stat">
          <i class="bi bi-currency-dollar text-success"></i>
          <span><strong>{{ deck.display_value }}</strong></span>
        </div>
        <div class="deck-stat text-muted">
          <i class="bi bi-clock"></i>
          <span>{{ deck.updated_at.strftime('%b %d') }}</span>
        </div>
      </div>
    </div>

    <div class="deck-card-footer">
      {% if deck.is_shared_with(current_user) %}
      <span class="shared-badge"><i class="bi bi-share me-1"></i>Shared with you</span>
      {% else %}
      <span class="text-muted" style="font-size:.78rem">
        <i class="bi bi-eye me-1"></i>View deck
      </span>
      {% endif %}
      <i class="bi bi-chevron-right ms-auto text-muted" style="font-size:.8rem"></i>
    </div>

  </a>
  {% endfor %}
</div>

{% else %}
<div class="text-center py-5">
  <i class="bi bi-layers" style="font-size:3rem;opacity:.25"></i>
  <h5 class="mt-3 fw-semibold">No public decks</h5>
  <p class="text-muted">{{ friend.username }} hasn't shared any decks with friends yet.</p>
</div>
{% endif %}

{% endblock %}
