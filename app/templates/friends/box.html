{% extends "base.html" %}
{% block title %}{{ friend.username }}'s Box — {{ get_setting('app_name', 'MagicDjinn') }}{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb mb-0">
  <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Home</a></li>
  <li class="breadcrumb-item"><a href="{{ url_for('friends.index') }}">Friends</a></li>
  <li class="breadcrumb-item active">{{ friend.username }}'s Box</li>
</ol>
{% endblock %}

{% block page_header %}
<div class="page-header d-flex align-items-center justify-content-between flex-wrap gap-2">
  <div>
    <h1><i class="bi bi-collection me-2 text-primary"></i>{{ friend.username }}'s Box</h1>
    <p class="lead mb-0">
      {{ cards | length }} slot{% if cards | length != 1 %}s{% endif %}
      · <a href="{{ url_for('friends.friend_decks', user_id=friend.id) }}" class="text-decoration-none">view decks →</a>
    </p>
  </div>
  <a href="{{ url_for('friends.index') }}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i>Back to Friends
  </a>
</div>
{% endblock %}

{% block head %}
<style>
.mtg-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: .85rem; }
@media (max-width: 576px) { .mtg-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: .6rem; } }

.mtg-card-tile {
  border-radius: 9px; cursor: pointer;
  transition: transform .2s, box-shadow .2s; position: relative;
}
.mtg-card-tile:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 12px 28px rgba(0,0,0,.35); z-index:5; }
.mtg-card-img-wrap {
  position: relative; aspect-ratio: 63/88;
  background: var(--bs-tertiary-bg); border-radius: 9px; overflow: hidden;
}
.mtg-card-img { width:100%; height:100%; object-fit:cover; display:block; border-radius:9px; }
.mtg-card-badges {
  position: absolute; top: 5px; right: 5px;
  display: flex; flex-direction: column; gap: 3px; align-items: flex-end;
}
.mtg-foil-shimmer {
  position: absolute; inset: 0; border-radius: 9px;
  background: linear-gradient(135deg,rgba(255,215,0,.0) 0%,rgba(255,215,0,.18) 30%,rgba(255,255,255,.12) 50%,rgba(180,0,255,.12) 70%,rgba(0,180,255,.0) 100%);
  pointer-events: none;
}
.mtg-card-info { padding: 5px 3px 3px; }
.mtg-card-name { font-size:.7rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.mtg-card-meta { font-size:.63rem; color:var(--bs-secondary-color); margin-top:2px; }

dialog#cardDialog {
  border:none; border-radius:14px; padding:0;
  width:min(520px,96vw);
  box-shadow: 0 20px 60px rgba(0,0,0,.4);
  background:var(--bs-body-bg); color:var(--bs-body-color);
}
dialog#cardDialog::backdrop { background:rgba(0,0,0,.55); }
.cd-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:.9rem 1.25rem .75rem;
  border-bottom:1px solid var(--bs-border-color);
}
.cd-body { padding:1rem 1.25rem; max-height:72vh; overflow-y:auto; }
.cd-footer {
  padding:.75rem 1.25rem;
  border-top:1px solid var(--bs-border-color);
  display:flex; justify-content:flex-end; gap:.5rem;
}
.cd-oracle { font-size:.8rem; line-height:1.6; white-space:pre-wrap; max-height:110px; overflow-y:auto; }
</style>
{% endblock %}

{% block content %}

<form method="get" class="d-flex gap-2 mb-3 flex-wrap align-items-center">
  <input type="search" name="q" value="{{ search }}"
         placeholder="Search cards…" class="form-control" style="max-width:240px">
  <div class="form-check ms-1">
    <input class="form-check-input" type="checkbox" name="foil" value="1"
           id="foilOnly" {% if foil_only %}checked{% endif %} onchange="this.form.submit()">
    <label class="form-check-label" for="foilOnly" style="font-size:.85rem">Foils only</label>
  </div>
  <button type="submit" class="btn btn-outline-secondary btn-sm"><i class="bi bi-search"></i></button>
  {% if search or foil_only %}
  <a href="{{ url_for('friends.friend_box', user_id=friend.id) }}" class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-x-lg"></i> Clear
  </a>
  {% endif %}
  <span class="text-muted ms-auto" style="font-size:.82rem">
    {{ cards | length }} slot{% if cards | length != 1 %}s{% endif %}
  </span>
</form>

{% if cards %}
<div class="mtg-grid">
  {% for inv in cards %}
  {% set card = inv.card %}
  <div class="mtg-card-tile" data-card='{{ {
    "inv_id":      inv.id,
    "max_qty":     inv.quantity,
    "is_foil":     inv.is_foil,
    "name":        card.name,
    "image":       card.image_normal or card.image_small or "",
    "set_code":    (card.set_code or "") | upper,
    "set_name":    card.set_name or "",
    "type_line":   card.type_line or "",
    "mana_cost":   card.mana_cost or "",
    "oracle_text": card.oracle_text or "",
    "rarity":      card.rarity or "",
    "usd":         card.usd,
    "usd_foil":    card.usd_foil
  } | tojson }}'>
    <div class="mtg-card-img-wrap">
      {% if card.image_normal or card.image_small %}
      <img src="{{ card.image_normal or card.image_small }}" alt="{{ card.name }}"
           class="mtg-card-img" loading="lazy">
      {% else %}
      <div class="d-flex align-items-center justify-content-center h-100">
        <i class="bi bi-question-circle text-muted" style="font-size:2rem"></i>
      </div>
      {% endif %}
      {% if inv.is_foil %}<div class="mtg-foil-shimmer"></div>{% endif %}
      <div class="mtg-card-badges">
        <span class="badge bg-dark bg-opacity-75" style="font-size:.65rem">×{{ inv.quantity }}</span>
        {% if inv.is_foil %}
        <span class="badge" style="font-size:.58rem;background:linear-gradient(135deg,#f59e0b,#ec4899,#8b5cf6)">FOIL</span>
        {% endif %}
      </div>
    </div>
    <div class="mtg-card-info">
      <div class="mtg-card-name" title="{{ card.name }}">{{ card.name }}</div>
      <div class="mtg-card-meta">
        {% if card.set_code %}{{ card.set_code | upper }}{% endif %}
        {% if card.display_price %}&nbsp;· {{ card.display_price }}{% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% else %}
<div class="text-center py-5">
  <i class="bi bi-collection" style="font-size:3rem;opacity:.25"></i>
  <h5 class="mt-3 fw-semibold">
    {% if search or foil_only %}No cards match your filter{% else %}{{ friend.username }}'s Box is empty{% endif %}
  </h5>
</div>
{% endif %}

{# ── Card Detail + Take dialog ─────────────────────────────────────────────── #}
<dialog id="cardDialog" aria-label="Card Details">
  <div class="cd-header">
    <div>
      <h5 class="mb-0 fw-bold" id="cdName"></h5>
      <small class="text-muted">from {{ friend.username }}</small>
    </div>
    <button type="button" class="btn-close" id="cdClose"></button>
  </div>
  <div class="cd-body">
    <div class="d-flex gap-3 mb-3">
      <div style="flex-shrink:0;width:150px">
        <img id="cdImage" src="" alt=""
             style="width:100%;border-radius:9px;box-shadow:0 4px 14px rgba(0,0,0,.3);display:block">
        <div id="cdFoilBadge" style="display:none;text-align:center;margin-top:.4rem">
          <span class="badge" style="background:linear-gradient(135deg,#f59e0b,#ec4899,#8b5cf6);font-size:.65rem">✦ FOIL</span>
        </div>
      </div>
      <div style="flex:1;min-width:0">
        <div id="cdType" class="text-muted mb-1" style="font-size:.8rem"></div>
        <div id="cdMana" class="mb-2" style="font-size:.85rem"></div>
        <div id="cdOracle" class="cd-oracle"
             style="border-top:1px solid var(--bs-border-color);padding-top:.5rem;margin-bottom:.5rem"></div>
        <div id="cdPrices" class="d-flex gap-2 flex-wrap"></div>
      </div>
    </div>

    <hr class="my-2">

    <div class="mb-1">
      <div class="fw-semibold mb-2" style="font-size:.85rem">
        <i class="bi bi-arrow-right-circle me-1 text-primary"></i>Take this card
      </div>
      <div class="d-flex gap-2 mb-2">
        <button type="button" id="cdDestBox" class="btn btn-sm btn-primary" style="flex:1">
          <i class="bi bi-collection me-1"></i>My Box
        </button>
        <button type="button" id="cdDestDeck" class="btn btn-sm btn-outline-secondary" style="flex:1"
                {% if not my_decks %}disabled title="You have no decks yet"{% endif %}>
          <i class="bi bi-layers me-1"></i>A Deck
        </button>
      </div>
      <div id="cdDeckRow" style="display:none;margin-bottom:.5rem">
        <select id="cdDeckSelect" class="form-select form-select-sm">
          {% for deck in my_decks %}
          <option value="{{ deck.id }}">{{ deck.name }} ({{ deck.format }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="d-flex align-items-center gap-2">
        <input type="number" id="cdQty" class="form-control form-control-sm"
               min="1" max="1" value="1" style="width:70px">
        <span id="cdQtyMax" class="text-muted" style="font-size:.8rem">of 1 available</span>
      </div>
    </div>
  </div>
  <div class="cd-footer">
    <button type="button" class="btn btn-outline-secondary btn-sm" id="cdCancel">Cancel</button>
    <button type="button" class="btn btn-primary btn-sm" id="cdTakeBtn">
      <i class="bi bi-arrow-right-circle me-1"></i>Take Card
    </button>
  </div>
</dialog>

{% endblock %}

{% block scripts %}
<script>
(function () {
  const CSRF     = document.querySelector('meta[name="csrf-token"]')?.content || '';
  const dlg      = document.getElementById('cardDialog');
  const cdDestBox  = document.getElementById('cdDestBox');
  const cdDestDeck = document.getElementById('cdDestDeck');
  const cdDeckRow  = document.getElementById('cdDeckRow');

  let pendingInvId = null;
  let destMode     = 'box';

  /* ── Destination toggle ─────────────────────────────────────────────── */
  function setDest(mode) {
    destMode = mode;
    if (mode === 'box') {
      cdDestBox.className  = 'btn btn-sm btn-primary';
      cdDestDeck.className = 'btn btn-sm btn-outline-secondary';
      cdDeckRow.style.display = 'none';
    } else {
      cdDestBox.className  = 'btn btn-sm btn-outline-secondary';
      cdDestDeck.className = 'btn btn-sm btn-primary';
      cdDeckRow.style.display = '';
    }
  }

  if (cdDestBox)  cdDestBox.addEventListener('click',  () => setDest('box'));
  if (cdDestDeck) cdDestDeck.addEventListener('click', () => setDest('deck'));
  document.getElementById('cdClose').addEventListener('click',  () => dlg.close());
  document.getElementById('cdCancel').addEventListener('click', () => dlg.close());

  /* ── Toast ──────────────────────────────────────────────────────────── */
  function showToast(msg, type) {
    const el = document.createElement('div');
    el.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    el.style.cssText = 'bottom:1.5rem;right:1.5rem;z-index:9999;min-width:240px;max-width:380px';
    el.innerHTML = `${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3500);
  }

  /* ── Open dialog on card click ──────────────────────────────────────── */
  document.querySelectorAll('.mtg-card-tile').forEach(tile => {
    tile.addEventListener('click', () => {
      const card = JSON.parse(tile.dataset.card);
      pendingInvId = card.inv_id;

      document.getElementById('cdName').textContent = card.name;

      const img = document.getElementById('cdImage');
      img.src = card.image || '';
      img.alt = card.name;

      document.getElementById('cdFoilBadge').style.display = card.is_foil ? '' : 'none';
      document.getElementById('cdType').textContent = card.type_line || '';
      document.getElementById('cdMana').innerHTML   = card.mana_cost ? window.renderMana(card.mana_cost) : '';
      document.getElementById('cdOracle').innerHTML = card.oracle_text ? window.renderMana(card.oracle_text) : '';

      const pricesEl = document.getElementById('cdPrices');
      pricesEl.innerHTML = '';
      if (card.usd != null)
        pricesEl.innerHTML += `<span class="badge bg-success" style="font-size:.72rem">$${parseFloat(card.usd).toFixed(2)}</span>`;
      if (card.usd_foil != null)
        pricesEl.innerHTML += `<span class="badge" style="font-size:.72rem;background:linear-gradient(135deg,#f59e0b,#a855f7);color:#fff">✦ $${parseFloat(card.usd_foil).toFixed(2)}</span>`;

      const qtyEl = document.getElementById('cdQty');
      qtyEl.max   = card.max_qty;
      qtyEl.value = Math.min(1, card.max_qty);
      document.getElementById('cdQtyMax').textContent = `of ${card.max_qty} available`;

      setDest('box');
      dlg.showModal();
    });
  });

  /* ── Take card ──────────────────────────────────────────────────────── */
  document.getElementById('cdTakeBtn').addEventListener('click', async () => {
    const qty = parseInt(document.getElementById('cdQty').value) || 1;
    const btn = document.getElementById('cdTakeBtn');

    let deckId = null;
    if (destMode === 'deck') {
      const sel = document.getElementById('cdDeckSelect');
      deckId = sel ? parseInt(sel.value) : null;
      if (!deckId) return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try {
      const res  = await fetch('/friends/transfer', {
        method:  'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
        body:    JSON.stringify({ inv_id: pendingInvId, deck_id: deckId, qty }),
      });
      const data = await res.json();
      dlg.close();
      if (res.ok && data.success) {
        showToast(data.message, 'success');
        setTimeout(() => location.reload(), 800);
      } else {
        showToast(data.error || 'Transfer failed.', 'danger');
      }
    } catch {
      showToast('Network error.', 'danger');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-arrow-right-circle me-1"></i>Take Card';
    }
  });
})();
</script>
{% endblock %}
