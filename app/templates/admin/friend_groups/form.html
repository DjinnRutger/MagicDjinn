{% extends "base.html" %}
{% block title %}{{ title }} — {{ get_setting('app_name', 'MagicDjinn') }}{% endblock %}

{% block page_header %}
<div class="page-header d-flex align-items-center justify-content-between gap-2">
  <div>
    <h1><i class="bi bi-people-fill me-2 text-primary"></i>{{ title }}</h1>
    <p class="lead mb-0">
      {% if group %}Editing group '{{ group.name }}'{% else %}Define a name and add members{% endif %}
    </p>
  </div>
  <a href="{{ url_for('admin.friend_groups') }}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i>Back to Groups
  </a>
</div>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-7">
    <div class="card">
      <div class="card-header">{{ title }}</div>
      <div class="card-body p-4">
        <form method="POST" novalidate>
          {{ form.hidden_tag() }}

          {# Group Name #}
          <div class="mb-4">
            {{ form.name.label(class="form-label fw-semibold") }}
            {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else ""),
                        placeholder="e.g. Columbus Game Night") }}
            {% for e in form.name.errors %}
            <div class="invalid-feedback">{{ e }}</div>
            {% endfor %}
            <div class="form-text">Members in this group can view each other's card Boxes and transfer cards.</div>
          </div>

          {# Member picker #}
          <div class="mb-4">
            <label class="form-label fw-semibold">Members</label>
            <div class="form-text mb-2">Click names to add or remove members. Hold Ctrl/Cmd to multi-select in the list, or use the checkboxes below.</div>

            {# Checkbox member picker (friendlier than a multi-select) #}
            <div class="border rounded p-3" style="max-height:320px;overflow-y:auto">
              <div class="row g-2" id="memberCheckboxes">
                {% for value, label in form.member_ids.choices %}
                <div class="col-sm-6 col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox"
                           name="member_ids" value="{{ value }}"
                           id="member_{{ value }}"
                           {% if value in (form.member_ids.data or []) %}checked{% endif %}>
                    <label class="form-check-label" for="member_{{ value }}" style="font-size:.88rem">
                      {{ label }}
                    </label>
                  </div>
                </div>
                {% else %}
                <p class="text-muted mb-0" style="font-size:.85rem">No users found.</p>
                {% endfor %}
              </div>
            </div>
            {% for e in form.member_ids.errors %}
            <div class="text-danger mt-1" style="font-size:.85rem">{{ e }}</div>
            {% endfor %}
          </div>

          <div class="d-flex gap-2">
            {{ form.submit(class="btn btn-primary") }}
            <a href="{{ url_for('admin.friend_groups') }}" class="btn btn-outline-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* Quick filter for the member list */
(function() {
  const box = document.getElementById('memberCheckboxes');
  const filter = document.createElement('input');
  filter.type = 'search';
  filter.className = 'form-control form-control-sm mb-2';
  filter.placeholder = 'Filter members…';
  box.parentElement.insertBefore(filter, box);
  filter.addEventListener('input', function() {
    const q = this.value.toLowerCase();
    box.querySelectorAll('.col-sm-6').forEach(col => {
      col.style.display = col.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
})();
</script>
{% endblock %}
